import"./DsnmJJEf.js";import"./BFNGBcc7.js";import{o as U}from"./CJgI0qws.js";import{K as D,L as F,p as H,a as Q}from"./9-_W6_Jj.js";import{i as Y}from"./Cjo9otzO.js";import{p as z}from"./Cv-eKTXv.js";import{s as J,b as w,c as B}from"./DMh7ZjmC.js";import{S as G,o as v,A as j,a as W,g as X,b as Z}from"./ha-UOQYi.js";import{s as ee,c as O,l as C,a as M,b as L}from"./C48CS4ZV.js";function P(a,n,c){var d=F(a,n);d&&d.set&&(a[n]=c,D(()=>{a[n]=null}))}function k(a){return`Bearer ${btoa(unescape(encodeURIComponent(a)))}`}async function ue(a,n,c){const d=`${G}/apps/${a}/subjects/createSubjectId/${n}`,r=await fetch(d,{method:"GET",headers:{accept:"application/json, text/plain, */*",authorization:k(c)}});if(!r.ok){const u=await r.text().catch(()=>"");throw new Error(`GET subject id failed ${r.status}: ${u}`)}return r.json()}async function pe(a,n,c,d=1,r=10){const u=`${G}/apps/${a}/subjects/${n}/scans?pageNo=${d}&pageSize=${r}`,m=await fetch(u,{method:"GET",headers:{accept:"application/json, text/plain, */*",authorization:k(c)}});if(!m.ok){const A=await m.text().catch(()=>"");throw new Error(`GET scans failed ${m.status}: ${A}`)}return m.json()}async function te(a,n,c,d){const r=`${G}/apps/${a}/subjects/${n}/scans/${c}`,u=await fetch(r,{method:"GET",headers:{accept:"application/json, text/plain, */*",authorization:k(d)}});if(!u.ok){const m=await u.text().catch(()=>"");throw new Error(`GET single scan failed ${u.status}: ${m}`)}return u.json()}function me(a,n){H(n,!1);const c=()=>B(M,"$copilotInitialized",r),d=()=>B(L,"$copilotVisible",r),[r,u]=J();let m=z(n,"onScanComplete",8,()=>{}),A=z(n,"onConcernOpen",8,()=>{}),f,y,I=!1;U(()=>{if(c()&&d()){const e=R();e&&(e.style.display="flex")}});function R(){let e=document.getElementById("copilotContainer");if(!e){e=document.createElement("div"),e.id="copilotContainer",e.style.cssText="display:none;position:fixed;inset:0;z-index:60;width:100%;height:100%;";const p=document.createElement("div");p.id="copilotSA",e.appendChild(p),document.body.appendChild(e)}return e}function x(){if(document.getElementById("glamarOverlay")){f=document.getElementById("glamarOverlay"),y=document.getElementById("GlamAR-Container");return}const e=document.createElement("div");e.id="glamarOverlay",e.innerHTML=`
      <div id="glamarModal">
        <div id="GlamAR-Container"></div>
        <button id="closeSdkBtn" aria-label="Close">Ã—</button>
      </div>
    `,document.body.appendChild(e),f=e,y=document.getElementById("GlamAR-Container")}function E(){x(),f&&(f.style.display="flex"),V()}function T(){try{window.GlamAR&&typeof window.GlamAR.close=="function"&&window.GlamAR.close()}catch{}if(f&&(f.style.display="none"),y)for(;y.firstChild;)y.removeChild(y.firstChild);I=!1}function V(){if(x(),f&&(f.style.display="flex"),I)return;if(!window.GlamAR||typeof window.GlamAR.init!="function"){console.error("GlamAR wrapper missing");return}w(C,!0),I=!0;const e=X(),p={platform:"web",category:"skingpt",meta:{sdkVersion:"2.0.0"},configuration:{skinAnalysis:{appId:j,userId:e}}};window.GlamAR.init("GlamAR-Container",Z,p),window.GlamAR.addEventListener?.("*",async(h,t)=>{if(h==="loading"&&w(C,!1),h==="closed"&&T(),h==="skin-gpt")try{const{accessToken:o,scanId:i,predictionId:s,appId:g,subjectId:l,retouchPredictionId:S,currencySymbols:_}=t||{},K={hostId:i,email:"example@gmail.com",additionalFields:{predictionId:s,scanId:i,retouchPredictionId:S,accessToken:o,appId:g,currencySymbols:_,onBoardingQuestions:v,subjectId:l}};c()||await $(K),window.copilot.context.set({predictionId:s,scanId:i,retouchPredictionId:S,accessToken:o,appId:g,currencySymbols:_,onBoardingQuestions:v,subjectId:l}),T(),window.copilot?.("event","sendUserMessage",{value:"analyze my skin"}),w(O,i),m()(t)}catch(o){console.error("Error handling skin-gpt:",o)}})}async function $(e={hostId:"1234",email:"example@gmail.com",additionalFields:{onBoardingQuestions:v}}){if(c())return!0;let p=!1;w(C,!0);const h=R();for(h&&(h.style.display="flex"),w(L,!0),(function(t,o,i,s,g,l,S){t[s]=t[s]||function(){(t[s].q=t[s].q||[]).push(arguments)},l=o.createElement(i),S=o.getElementsByTagName(i)[0],l.id=s,l.src=g,l.async=1,l.referrerPolicy="origin",S.parentNode.insertBefore(l,S)})(window,document,"script","copilot","https://script.copilot.live/v1/copilot.min.js?tkn=cat-pnxlzhq8"),window.copilot("init",{element:"copilotSA",position:"initial",hideConversation:!0},function(){try{window.copilot?.users?.set?.(e)}catch{}p=!0,w(C,!1);try{window.copilot.callbacks.add({name:"open_glamar",handler:t=>(E(),{success:!0})})}catch{}try{window.copilot.callbacks.add({name:"open_concern",handler:t=>{const o=String(t?.value||"");return console.log(o),b(o),{success:!0}}})}catch{}});!p;)await new Promise(t=>setTimeout(t,50));return w(M,!0),p}async function b(e){const p=ee.subscribe(i=>{b.sid=i}),h=O.subscribe(i=>{b.scanId=i});p(),h();const t=b.sid,o=b.scanId;if(console.log("kailyShowMore",t,o),t&&o)try{let s=(await te(j,t,o,W))?.report_data?.output?.skinData?.concerns;if(s){const g=s.find(l=>String(l.tech_name).toLowerCase()===e.toLowerCase());A()(s,g?.name||e)}}catch(i){console.error("getSingleScan failed:",i)}}var N={showGlamARSdk:E,showCopilot:$};Y(),P(n,"showGlamARSdk",E),P(n,"showCopilot",$);var q=Q(N);return u(),q}export{me as G,ue as a,pe as g};
