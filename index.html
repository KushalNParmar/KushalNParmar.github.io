<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>3D Model Viewer with AR</title>
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.js"
    ></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f5f5f5;
        font-family: Arial, sans-serif;
      }
      model-viewer {
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
      }

      /* Hide the default progress bar from model-viewer */
      model-viewer::part(progress-bar) {
        display: none;
      }

      /* Custom Progress Bar Styles */
      .custom-progress-bar {
        width: 100%;
        height: 5px; /* Height of the progress bar */
        background-color: #e6e6e6; /* Background color */
        position: absolute;
        top: 0;
        left: 0;
      }

      .progress-bar-inner {
        height: 100%;
        width: 0%; /* Will be updated dynamically */
        background-color: #da0e64; /* Progress bar color */
      }

      /* Error message styling */
      #error-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: red;
        font-size: 20px;
        background-color: rgba(0, 0, 0, 0.6);
        padding: 10px;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <!-- Model Viewer Component -->
    <model-viewer
      id="model-viewer"
      src="https://cdn.pixelbin.io/v2/glamar-fynd-835885/original/glamar-3d-models/home_decor/15/wardrobe_01.gltf"
      ar=""
      autoplay=""
      ar-scale="fixed"
      ar-modes="webxr scene-viewer quick-look"
      camera-controls=""
      disable-zoom=""
      disable-tap=""
      touch-action="pan-y"
      tone-mapping="neutral"
      poster="poster.webp"
      shadow-intensity="1"
      skybox-height="1.5m"
      onload="onModelLoaded()"
      ar-status="not-presenting"
    >
      <!-- Custom Progress Bar -->
      <div class="custom-progress-bar">
        <div
          class="progress-bar-inner"
          id="progress-bar"
          style="width: 100%; display: block"
        ></div>
      </div>
    </model-viewer>

    <!-- Error message container -->
    <div id="error-message" style="display: none">
      Error: Model URL is missing or invalid!
    </div>

    <script>
      // Function to handle model loading and trigger AR directly
      function onModelLoaded() {
        const modelViewer = document.getElementById("model-viewer");
        const loader = document.getElementById("progress-bar");

        // Enable AR mode immediately upon model load if it's available
        if (modelViewer && modelViewer.canActivateAR) {
          modelViewer.activateAR(); // Automatically trigger AR
        }
      }

      // Retrieve the model URL from the query string
      const modelUrl = new URLSearchParams(window.location.search).get("model");
      const modelViewer = document.getElementById("model-viewer");

      // Show loader and track model download progress
      modelViewer.addEventListener("progress", (event) => {
        const progressBar = document.getElementById("progress-bar");
        const progress = event.detail.totalProgress;

        // Update the progress bar's width dynamically as the model loads
        const progressBarInner = document.querySelector(".progress-bar-inner");
        progressBarInner.style.width = progress * 100 + "%";

        // Show the loader while the model is loading
        if (progress !== 1) {
          progressBar.style.display = "block";
        }

        // Once the model is fully loaded and AR is ready, activate AR
        if (progress === 1) {
          modelViewer.addEventListener("ar-status", (arEvent) => {
            if (arEvent.detail.status === "activated") {
              // Hide loader once AR is activated
              progressBar.style.display = "none";
              // Hide 3D model viewer when AR is activated
              modelViewer.style.display = "none";
            }
          });
        }
      });

      // Check if a valid model URL was passed
      if (modelUrl && modelUrl.trim() !== "") {
        // Validate the model URL (basic check to see if it's a valid URL format)
        try {
          new URL(modelUrl); // This will throw if the URL is invalid
          modelViewer.setAttribute("src", modelUrl); // Set the model URL to the viewer
        } catch (e) {
          // If URL is invalid, display the error message
          document.getElementById("error-message").textContent =
            "Error: Invalid model URL!";
          document.getElementById("error-message").style.display = "block";
        }
      } else {
        // If no model URL is provided, display the error message
        document.getElementById("error-message").textContent =
          "Error: Model URL is missing!";
        document.getElementById("error-message").style.display = "block";
      }
    </script>
  </body>
</html>
