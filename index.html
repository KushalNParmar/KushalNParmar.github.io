<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkinGPT | GlamAR</title>

    <style>
      /* ---------- Design tokens ---------- */
      :root {
        /* Base */
        --color-bg: #ffffff;
        --color-text: #000000;
        --color-text-muted: #4d4d4d;

        /* Surfaces / borders */
        --color-surface: #fafafa;
        --color-surface-strong: #ffffff;
        --color-border: #e7e7e7;
        --color-border-soft: rgba(229, 229, 229, 0.25);
        --color-border-input: rgba(229, 229, 229, 0.9);

        /* Brand */
        --color-focus: #da0e64;

        /* Icon */
        --color-icon: #000000;

        /* Shadow */
        --color-shadow: #e13e8305;
      }

      /* ---------- Base (mobile-first: 320x640) ---------- */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;

        color: var(--color-text);
        overscroll-behavior: none;

        /* no scrolling in any resolution */
        height: 100svh;
        overflow: hidden;

        background: var(--color-bg);
      }

      main {
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;

        padding: 1.25rem 1rem;
        gap: 1rem;

        overflow: hidden;
        min-height: 0;
      }

      .hero-title {
        margin: 0;
        font-size: 2.25rem;
        font-weight: 700;
        color: var(--color-text);
        text-align: center;
        line-height: 1.05;
      }

      .hero-subtitle {
        margin: 0;
        font-size: 0.95rem;
        color: var(--color-text-muted);
        text-align: center;
      }

      /* ---------- Chat composer (textarea + chips + send INSIDE one box) ---------- */
      .search-container {
        width: 100%;
        max-width: 19.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .composer {
        width: 100%;
      }

      /* KEY FIX:
         Use grid so textarea lives in its own row and never gets covered by chips/send. */
      .composer-inner {
        background: var(--color-surface-strong);
        border: 0.0625rem solid var(--color-border-input);
        border-radius: 1rem;

        padding: 0.9rem;
        display: grid;
        grid-template-rows: auto auto;
        gap: 0.75rem;

        overflow: hidden;
      }

      .composer-inner:focus-within {
        border-color: var(--color-focus);
      }

      .composer-input {
        width: 100%;
        resize: none;
        border: 0;
        outline: none;
        background: transparent;
        color: var(--color-text);

        font-size: 1rem;
        line-height: 1.35;

        /* Grow until ~5 lines, then scroll */
        max-height: 7.2rem;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;

        /* Prevent textarea from pushing layout weirdly */
        min-height: 1.35rem;
      }

      .composer-input::placeholder {
        color: #8f8f8f; /* keep as-is */
      }

      /* Bottom row inside the box */
      .composer-bottom {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: end;
        gap: 0.75rem;
      }

      /* Chips: wrap, but canâ€™t steal textarea space anymore */
      .chips {
        display: flex;
        gap: 0.6rem;
        flex-wrap: wrap;
        align-items: center;

        min-width: 0;
      }

      .suggestion-btn {
        background: var(--color-surface);
        color: var(--color-text);
        border: 0.0625rem solid var(--color-border);
        padding: 0.65rem 0.9rem;
        border-radius: 999rem;
        font-size: 0.9rem;
        cursor: pointer;

        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;

        max-width: 100%;
      }

      .suggestion-btn:hover {
        background: var(--color-border);
      }

      .cta {
        width: 2.75rem;
        height: 2.75rem;
        border-radius: 50%;
        background: var(--color-surface);
        border: 0.0625rem solid var(--color-border);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        padding: 0.3rem;
        flex: 0 0 auto;
      }

      .cta svg {
        width: 1.1rem;
        height: 1.1rem;
        color: var(--color-icon);
      }

      /* ---------- Other sections ---------- */
      .features-container {
        width: 100%;
        max-width: 19.5rem;
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }

      .feature-card {
        background: var(--color-surface);
        border: 0.0625rem solid var(--color-border);
        border-radius: 1rem;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }

      .feature-card:hover {
        transform: translateY(-0.15rem);
        box-shadow:
          0 1.5rem 2rem 0.0625rem var(--color-shadow),
          0 0.75rem 0.75rem -0.375rem var(--color-shadow),
          0 0.375rem 0.375rem -0.1875rem var(--color-shadow),
          0 0.1875rem 0.1875rem -0.09375rem var(--color-shadow),
          0 0.0625rem 0.0625rem -0.03125rem var(--color-shadow),
          0 0 0 0 var(--color-shadow);
      }

      .feature-image {
        width: 100%;
        height: 5.5rem;
        border-radius: 0.75rem;
        margin-bottom: 0.75rem;
        background: var(--color-surface-strong);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
      }

      .feature-title {
        margin: 0 0 0.35rem;
        font-size: 1rem;
        font-weight: 600;
        color: var(--color-text);
      }

      .feature-description {
        margin: 0;
        font-size: 0.85rem;
        color: var(--color-text-muted);
      }

      .skin-portrait-section {
        width: 100%;
        max-width: 19.5rem;
        background: var(--color-surface);
        border: 0.0625rem solid var(--color-border);
        border-radius: 1rem;
        display: flex;
        justify-content: center;
        padding: 0.75rem;
      }

      .skin-portrait-link {
        text-decoration: none;
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }

      .skin-portrait-image {
        width: 4.25rem;
        height: 4.25rem;
        border-radius: 50%;
        background: var(--color-surface-strong);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 1.7rem;
      }

      .skin-portrait-label {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--color-text);
      }

      footer {
        width: 100%;
        max-width: 19.5rem;
        text-align: center;
        padding: 0.75rem 0.75rem;
        border-top: 0.0625rem solid var(--color-border-soft);
        background: var(--color-surface);
        border-radius: 0.75rem;
      }

      .footer-text {
        margin: 0;
        font-size: 0.8rem;
        color: var(--color-text);
      }

      .footer-links {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
      }

      .footer-link {
        color: var(--color-text);
        text-decoration: none;
        font-size: 0.8rem;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
      }

      .footer-link:hover {
        text-decoration: underline;
      }

      .dot-separator {
        color: var(--color-text);
      }

      #copilotContainer {
        position: fixed;
        inset: 0;
        z-index: 10;
        background: #fff;
        display: flex;
      }
      #copilotSA {
        width: 100%;
        height: 100%;
      }
      #glamarOverlay {
        position: fixed;
        inset: 0;
        z-index: 999999;
        background: rgba(0, 0, 0, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
      }
      #glamarModal {
        position: relative;
        width: 100%;
        height: 100%;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
      }

      #GlamAR-Container {
        width: 100%;
        height: 100%;
        background: #fff;
        overflow: hidden;
      }

      .loader {
        width: 100%;
        height: 100%;
        background: #00000052;
        position: fixed;
        z-index: 1000000;
        display: none;
        align-items: center;
        justify-content: center;
        /* backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px); */
      }
      .loader.active {
        display: flex;
      }
      .loader svg {
        max-width: 200px;
        max-height: 200px;
      }

      /* ---------- Required media queries (same structure, updated for composer) ---------- */

      @media (min-width: 648px) {
        main {
          padding: 1.75rem 1.5rem;
          gap: 1.1rem;
        }

        .hero-title {
          font-size: 2.8rem;
        }

        .hero-subtitle {
          font-size: 1rem;
        }

        .search-container,
        .features-container,
        .skin-portrait-section,
        footer {
          max-width: 26rem;
        }

        .composer-input {
          font-size: 1rem;
          max-height: 7.2rem;
        }

        .cta {
          width: 2.75rem;
          height: 2.75rem;
        }

        .features-container {
          grid-template-columns: 1fr 1fr;
          gap: 0.9rem;
        }

        .feature-card {
          padding: 1.1rem;
        }

        .feature-image {
          height: 6.5rem;
          font-size: 2.25rem;
        }

        .skin-portrait-section {
          padding: 0.9rem;
        }
      }

      /* Tablet Landscape */
      @media (min-width: 720px) and (orientation: landscape) {
        main {
          padding: 1.25rem 2rem;
          gap: 1rem;
        }

        .hero-title {
          font-size: 3rem;
        }

        .hero-subtitle {
          font-size: 1.05rem;
        }

        .search-container,
        .features-container,
        .skin-portrait-section,
        footer {
          max-width: 32rem;
        }

        .composer-input {
          font-size: 1.05rem;
          max-height: 7.6rem;
        }

        .suggestion-btn {
          padding: 0.7rem 1rem;
          font-size: 0.95rem;
        }

        .feature-card {
          padding: 1.15rem;
        }

        .feature-image {
          height: 6rem;
          font-size: 2.35rem;
        }

        .skin-portrait-image {
          width: 4.6rem;
          height: 4.6rem;
          font-size: 1.85rem;
        }
      }

      @media (min-width: 656px) and (orientation: portrait) {
        main {
          padding: 2rem 1.75rem;
          gap: 1.2rem;
        }

        .hero-title {
          font-size: 3.1rem;
        }

        .hero-subtitle {
          font-size: 1.05rem;
        }

        .search-container,
        .features-container,
        .skin-portrait-section,
        footer {
          max-width: 28rem;
        }

        .composer-input {
          font-size: 1.05rem;
          max-height: 7.6rem;
        }

        .feature-card {
          padding: 1.15rem;
        }

        .feature-image {
          height: 6.75rem;
          font-size: 2.35rem;
        }

        .skin-portrait-section {
          padding: 1rem;
        }
      }

      /* Big Tablet Landscape */
      @media (min-width: 1000px) and (orientation: landscape) {
        main {
          padding: 2rem 3rem;
          gap: 1.25rem;
        }

        .hero-title {
          font-size: 3.5rem;
        }

        .hero-subtitle {
          font-size: 1.1rem;
        }

        .search-container,
        .features-container,
        .skin-portrait-section,
        footer {
          max-width: 40rem;
        }

        .composer-input {
          font-size: 1.1rem;
          max-height: 8.2rem;
        }

        .suggestion-btn {
          padding: 0.75rem 1.05rem;
          font-size: 1rem;
        }

        .feature-card {
          padding: 1.25rem;
        }

        .feature-image {
          height: 7.25rem;
          font-size: 2.5rem;
        }

        .skin-portrait-image {
          width: 5rem;
          height: 5rem;
          font-size: 2rem;
        }
      }

      /* Web portrait */
      @media (min-width: 846px) and (orientation: portrait) {
        main {
          padding: 2.25rem 2.25rem;
          gap: 1.35rem;
        }

        .hero-title {
          font-size: 3.6rem;
        }

        .hero-subtitle {
          font-size: 1.1rem;
        }

        .search-container,
        .features-container,
        .skin-portrait-section,
        footer {
          max-width: 36rem;
        }

        .composer-input {
          font-size: 1.1rem;
          max-height: 8.2rem;
        }

        .features-container {
          gap: 1rem;
        }

        .feature-card {
          padding: 1.25rem;
        }

        .feature-image {
          height: 7.5rem;
          font-size: 2.6rem;
        }

        .skin-portrait-image {
          width: 5rem;
          height: 5rem;
          font-size: 2rem;
        }

        .footer-text,
        .footer-link {
          font-size: 0.85rem;
        }
      }

      /* web Landscape */
      @media (min-width: 1440px) and (orientation: landscape) {
        main {
          padding: 2.5rem 4rem;
          gap: 1.5rem;
        }

        .hero-title {
          font-size: 4rem;
        }

        .hero-subtitle {
          font-size: 1.15rem;
        }

        .search-container,
        .features-container,
        .skin-portrait-section,
        footer {
          max-width: 46rem;
        }

        .composer-input {
          font-size: 1.05rem;
          max-height: 8.2rem;
        }

        .suggestion-btn {
          padding: 0.75rem 1.1rem;
          font-size: 1rem;
        }

        .feature-card {
          padding: 1.25rem;
        }

        .feature-image {
          height: 8rem;
          font-size: 2.75rem;
        }

        .skin-portrait-section {
          padding: 1.1rem;
        }

        .skin-portrait-image {
          width: 5.25rem;
          height: 5.25rem;
          font-size: 2.1rem;
        }

        footer {
          padding: 0.9rem 0.9rem;
        }

        .footer-text,
        .footer-link {
          font-size: 0.9rem;
        }
      }

      /* TV portrait */
      @media (min-width: 1080px) and (orientation: portrait) {
        .cta {
          width: 7.9rem;
          height: 7.9rem;
          padding: 0.49rem;
          border-radius: 0.99rem;
        }
        .cta svg {
          width: 2.96rem;
          height: 2.96rem;
        }
      }

      /* TV landscape */
      @media (min-width: 1920px) and (orientation: landscape) {
        .cta {
          width: 4.45rem;
          height: 4.45rem;
          padding: 0.28rem;
          border-radius: 0.56rem;
        }
        .cta svg {
          width: 1.67rem;
          height: 1.67rem;
        }
      }
    </style>
  </head>

  <body>
    <div id="loader" class="loader"></div>
    <main>
      <h1 class="hero-title">SkinGPT</h1>
      <p class="hero-subtitle">Your AI skincare assistant</p>

      <div class="search-container">
        <div class="composer">
          <div class="composer-inner">
            <textarea
              class="composer-input"
              rows="1"
              placeholder="How can I help you today?"
            ></textarea>

            <div class="composer-bottom">
              <div class="chips">
                <button class="suggestion-btn" type="button">
                  How do I improve my skin texture?
                </button>
                <button class="suggestion-btn" type="button">
                  Recommend a good moisturizer
                </button>
              </div>

              <button class="cta" type="button" aria-label="Send">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path
                    d="M5 12h12M13 6l6 6-6 6"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="features-container">
        <div class="feature-card" id="analyze" role="button" tabindex="0">
          <div class="feature-image">ðŸ“¸</div>
          <h3 class="feature-title">Analyze my skin</h3>
          <p class="feature-description">by taking a quick photo</p>
        </div>

        <div class="feature-card" id="personalise" role="button" tabindex="0">
          <div class="feature-image">âœ“</div>
          <h3 class="feature-title">Build my personalized</h3>
          <p class="feature-description">skincare routine</p>
        </div>
      </div>

      <div class="skin-portrait-section">
        <a href="/skin-portrait" class="skin-portrait-link">
          <div class="skin-portrait-image">ðŸ‘¤</div>
          <div class="skin-portrait-label">Skin Portrait</div>
        </a>
      </div>

      <footer>
        <div class="footer-links">
          <p class="footer-text">SkinGPT may make mistakes.</p>
          <a href="" class="footer-link">Privacy</a>
          <span class="dot-separator">âˆ™</span>
          <a href="" class="footer-link">Cookie</a>
          <span class="dot-separator">âˆ™</span>
          <button class="footer-link" type="button">Consent Settings</button>
        </div>
      </footer>
    </main>
    <div id="copilotContainer"><div id="copilotSA"></div></div>

    <script src="https://cdn.glamarz0.de/sdk/wrapper"></script>
    <script src="https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js"></script>

    <!-- Copilot loader -->
    <script type="application/javascript">
      const loader = document.getElementById("loader");
      let loaderAnimation = null;

      function initLoader() {
        if (!loader || loaderAnimation) return;

        loaderAnimation = lottie.loadAnimation({
          container: loader,
          renderer: "svg",
          loop: true,
          autoplay: true,
          width: "200px",
          height: "200px",
          path: "https://cdn.pixelbin.io/v2/dummy-cloudname/original/__glam_ar/__sdk/saloader_light.json",
        });
      }

      function showLoader() {
        initLoader();
        document.getElementById("loader")?.classList.add("active");
      }

      function hideLoader() {
        document.getElementById("loader")?.classList.remove("active");
      }

      async function showCopilot(
        userSettings = {
          hostId: "1234", // MUST be stable per user
          email: "example@gmail.com", // Mandatory (either email or phone)
          additionalFields: {},
        },
      ) {
        let copilotReady = false;
        showLoader();
        copilotContainer.style.display = "flex";
        (function (w, d, s, o, f, js, fjs) {
          w[o] =
            w[o] ||
            function () {
              (w[o].q = w[o].q || []).push(arguments);
            };
          js = d.createElement(s);
          fjs = d.getElementsByTagName(s)[0];
          js.id = o;
          js.src = f;
          js.async = 1;
          js.referrerPolicy = "origin";
          fjs.parentNode.insertBefore(js, fjs);
        })(
          window,
          document,
          "script",
          "copilot",
          "https://script.copilot.live/v1/copilot.min.js?tkn=cat-pnxlzhq8",
        );

        copilot(
          "init",
          { element: "copilotSA", position: "initial" },
          function () {
            try {
              console.log("users.set succeeded:", userSettings);
              window?.copilot?.users?.set?.(userSettings);
            } catch (e) {
              console.warn("users.set failed:", e);
            }
            copilotReady = true;
            console.log("âœ… Copilot ready");
            hideLoader();
          },
        );

        while (!copilotReady) {
          await new Promise((resolve) => setTimeout(resolve, 50));
        }
        return copilotReady;
      }

      /************************************************************************
       * Overlay and GlamAR init / lifecycle
       ************************************************************************/

      let glamAROverlay = null;
      let glamARContainer = null;
      const copilotContainer = document.getElementById("copilotContainer");
      const analyzeBtn = document.getElementById("analyze");
      const personaliseBtn = document.getElementById("personalise");
      const textarea = document.querySelector(".composer-input");
      const chips = document.querySelectorAll(".suggestion-btn");
      const sendBtn = document.querySelector(".cta");
      copilotContainer.style.display = "none";

      const autosize = () => {
        textarea.style.height = "auto";
        const maxH = parseFloat(getComputedStyle(textarea).maxHeight);
        textarea.style.height = Math.min(textarea.scrollHeight, maxH) + "px";
      };

      autosize();
      textarea.addEventListener("input", autosize);

      chips.forEach((btn) => {
        btn.addEventListener("click", () => {
          textarea.value = btn.textContent.trim();
          textarea.focus();
          autosize();
        });
      });

      personaliseBtn.addEventListener("click", async () => {
        await showCopilot();
        copilot("event", "sendUserMessage", {
          value: "Build my personalized skincare routine",
        });
      });

      sendBtn.addEventListener("click", async () => {
        const message = textarea.value.trim();

        if (!message) return; // prevent empty sends

        await showCopilot();
        copilot("event", "sendUserMessage", {
          value: message,
        });

        // optional UX cleanup
        textarea.value = "";
        textarea.style.height = "auto";
      });

      analyzeBtn.addEventListener("click", () => {
        showGlamARSdk();
      });

      function ensureOverlay() {
        if (document.getElementById("glamarOverlay")) {
          glamAROverlay = document.getElementById("glamarOverlay");
          glamARContainer = document.getElementById("GlamAR-Container");
          return;
        }

        const overlay = document.createElement("div");
        overlay.id = "glamarOverlay";
        overlay.innerHTML = `
          <div id="glamarModal">
            <div id="GlamAR-Container"></div>
            <button id="closeSdkBtn" aria-label="Close">Ã—</button>
          </div>
        `;
        document.body.appendChild(overlay);

        glamAROverlay = overlay;
        glamARContainer = document.getElementById("GlamAR-Container");
      }

      function showGlamARSdk() {
        ensureOverlay();
        glamAROverlay.style.display = "flex";
        initGlamAr();
      }

      function closeGlamARSdk() {
        try {
          if (window.GlamAR && typeof window.GlamAR.close === "function")
            window.GlamAR.close();
        } catch (e) {}
        if (glamAROverlay) glamAROverlay.style.display = "none";
        if (glamARContainer)
          while (glamARContainer.firstChild)
            glamARContainer.removeChild(glamARContainer.firstChild);
        window.__GLAMAR_INITIALIZED__ = false;
      }

      /************************************************************************
       * GlamAR initialization and event handling
       ************************************************************************/
      function initGlamAr() {
        ensureOverlay();
        glamAROverlay.style.display = "flex";

        if (window.__GLAMAR_INITIALIZED__) return;

        if (!window.GlamAR || typeof window.GlamAR.init !== "function") {
          console.error("GlamAR wrapper missing");
          return;
        }
        showLoader();

        window.__GLAMAR_INITIALIZED__ = true;

        const config = {
          platform: "web",
          category: "skingpt",
          meta: { sdkVersion: "2.0.0" },
          configuration: {
            skinAnalysis: { appId: "fecf3bc7-c9ec-4c47-8555-98a74df58288" },
          },
        };

        window.GlamAR.init(
          "GlamAR-Container",
          "ba843e66-4b93-48f6-a02e-ea48d920e52e",
          config,
        );

        // Unified event listener
        window.GlamAR.addEventListener?.("*", async (event, payload) => {
          console.log("GlamAR Event:", event, payload);
          if (event === "loading") {
            hideLoader();
          }

          if (event === "closed") {
            closeGlamARSdk();
          }

          if (event === "skin-gpt") {
            // sdk returned a blob + identifiers
            try {
              const {
                accessToken, // string token
                scanId, // string
                predictionId, // string (skin prediction id)
                appId, // sdk app id (should match your app)
                subjectId,
                retouchPredictionId, // optional - retouch poll id
              } = payload || {};

              const userSettings = {
                hostId: subjectId, // MUST be stable per user
                email: "example@gmail.com", // Mandatory (either email or phone)
                additionalFields: {
                  predictionId: predictionId,
                  scanId: scanId,
                  retouchPredictionId: retouchPredictionId,
                  accessToken: accessToken,
                  appId: appId,
                },
              };

              await showCopilot(userSettings);

              closeGlamARSdk();
            } catch (e) {
              console.error("Error handling skin-gpt:", e);
            }
          }
        }); // end addEventListener
      } // end initGlamAr
    </script>
  </body>
</html>
