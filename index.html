<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kaily + GlamAR Overlay (Plus button inside chat)</title>

    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
      }

      /* Kaily container */
      #copilotContainer {
        position: fixed;
        inset: 0;
        z-index: 10;
        background: #fff;
        display: flex;
      }
      #copilotSA {
        width: 100%;
        height: 100%;
      }

      /* GlamAR overlay */
      #glamarOverlay {
        position: fixed;
        inset: 0;
        z-index: 999999;
        background: rgba(0, 0, 0, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
      }

      #glamarModal {
        position: relative;
        width: min(100%, 1200px);
        height: min(100%, 800px);
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
      }

      @media (max-width: 768px) {
        #glamarModal {
          width: 100%;
          height: 100%;
          border-radius: 0;
        }
      }

      #closeSdkBtn {
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 2;
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 999px;
        font-size: 22px;
        cursor: pointer;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.2);
        background: #fff;
      }

      #GlamAR-Container {
        width: 100%;
        height: 100%;
        background: #ffffff;
        overflow: hidden;
      }
    </style>

    <!-- GlamAR wrapper -->
    <script src="https://cdn.glamarz0.de/sdk/wrapper"></script>

    <!-- Copilot loader -->
    <script type="application/javascript">
      (function (w, d, s, o, f, js, fjs) {
        w[o] =
          w[o] ||
          function () {
            (w[o].q = w[o].q || []).push(arguments);
          };
        js = d.createElement(s);
        fjs = d.getElementsByTagName(s)[0];
        js.id = o;
        js.src = f;
        js.async = 1;
        js.referrerPolicy = "origin";
        fjs.parentNode.insertBefore(js, fjs);
      })(
        window,
        document,
        "script",
        "copilot",
        "https://script.copilot.live/v1/copilot.min.js?tkn=cat-pnxlzhq8",
      );
      let glamAROverlay;
      let glamARContainer;

      /* -------------------------
       * Helpers: Blob -> URL
       * ------------------------- */
      function blobToDataUrl(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result); // data:image/...;base64,...
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }

      function trySendImageToKaily(imgUrl) {
        const attempts = [
          { type: "image", url: imgUrl },
          { type: "attachment", url: imgUrl, mime: "image/jpeg" },
          { type: "image", content: { url: imgUrl } },
          { type: "message", attachments: [{ type: "image", url: imgUrl }] },
          { type: "message", media: [{ type: "image", url: imgUrl }] },
        ];

        for (const payload of attempts) {
          try {
            console.log("üß™ Trying sendUserMessage payload:", payload);
            copilot("event", "sendUserMessage", payload);
          } catch (e) {
            console.warn("‚ùå sendUserMessage attempt failed:", payload, e);
          }
        }
      }

      /* ------------------------------------------------
       * Guaranteed fallback: render image via components
       * ------------------------------------------------ */
      function queueSkinGptImageForComponents(imgSrc) {
        window.__PENDING_SKIN_GPT_IMAGE__ = {
          src: imgSrc,
          ts: Date.now(),
        };

        // Trigger bot to call tool:components.
        // Your bot prompt should map this phrase to tool:components.
        copilot("event", "sendUserMessage", { value: "show skin gpt image" });
      }

      /* -------------------------
       * Overlay helpers
       * ------------------------- */
      function ensureOverlay() {
        if (document.getElementById("glamarOverlay")) return;

        const overlay = document.createElement("div");
        overlay.id = "glamarOverlay";
        overlay.innerHTML = `
          <div id="glamarModal">
            <button id="closeSdkBtn" aria-label="Close">√ó</button>
            <div id="GlamAR-Container"></div>
          </div>
        `;
        document.body.appendChild(overlay);

        overlay
          .querySelector("#closeSdkBtn")
          .addEventListener("click", closeGlamARSdk);
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) closeGlamARSdk();
        });
        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeGlamARSdk();
        });
        glamAROverlay = document.getElementById("glamarOverlay");
        glamARContainer = document.getElementById("GlamAR-Container");
      }

      function showGlamARSdk() {
        ensureOverlay();
        document.getElementById("glamarOverlay").style.display = "flex";
        initGlamAr();
      }

      function closeGlamARSdk() {
        window.GlamAR.close();
        glamAROverlay.style.display = "none";
        while (glamARContainer.firstChild) {
          glamARContainer.removeChild(glamARContainer.firstChild);
        }
        window.__GLAMAR_INITIALIZED__ = false;
      }

      /* -------------------------
       * GlamAR init
       * ------------------------- */
      function initGlamAr() {
        glamAROverlay.style.display = "block";

        if (window.__GLAMAR_INITIALIZED__) return;

        if (!window.GlamAR || typeof window.GlamAR.init !== "function") {
          console.error("‚ùå GlamAR wrapper not loaded / GlamAR.init missing");
          return;
        }

        window.__GLAMAR_INITIALIZED__ = true;

        const config = {
          platform: "web",
          category: "skingpt",
          meta: { sdkVersion: "2.0.0" },
          configuration: {
            skinAnalysis: {
              appId: "fecf3bc7-c9ec-4c47-8555-98a74df58288",
            },
          },
        };

        window.GlamAR.init(
          "GlamAR-Container",
          "ba843e66-4b93-48f6-a02e-ea48d920e52e",
          config,
        );

        window.GlamAR.addEventListener?.("*", async (event, payload) => {
          console.log(`GlamAR Event:`, event, payload);
          switch (event) {
            case "loaded":
              console.log("SDK Loaded");
              break;
            case "opened":
              console.log("SDK Opened");
              break;
            case "closed":
              console.log("SDK Closed");
              break;
            case "camera-failed":
              console.log("SDK Camera Failed");
              break;
            case "error":
              console.log("SDK Error", event);
              break;
            case "skin-gpt":
              if (event !== "skin-gpt") return;

              window.GlamAR.close();

              glamAROverlay.style.display = "none";
              while (glamARContainer.firstChild) {
                glamARContainer.removeChild(glamARContainer.firstChild);
              }
              window.__GLAMAR_INITIALIZED__ = false;
              const blob = payload?.image;
              if (!(blob instanceof Blob)) {
                console.warn("skin-gpt payload.image is not a Blob:", blob);
                return;
              }

              // Convert to data URL (safe to embed)
              try {
                const dataUrl = await blobToDataUrl(blob);

                // ‚úÖ Experiment: try sending as image message (may not work)
                trySendImageToKaily(dataUrl);

                // ‚úÖ Guaranteed: render via tool:components
                queueSkinGptImageForComponents(dataUrl);

                let base64tkn = btoa(
                  unescape(encodeURIComponent(payload?.accessToken)),
                );
                console.log(payload?.accessToken, base64tkn);

                const finalRes = await pollSkinAnalysis(
                  payload?.scanId,
                  payload?.predictionId,
                  payload?.appId,
                  base64tkn,
                  {
                    intervalMs: 2500,
                    maxAttempts: 200,
                  },
                );
                console.log("‚úÖ FINAL:", finalRes);
                copilot("event", "sendUserMessage", {
                  value: buildSkinSummary(finalRes),
                });
              } catch (err) {
                console.error("‚ùå Failed to convert blob to dataUrl", err);
              }
              break;
          }
        });
      }

      const SA_BASE = "https://api.pixelbinz0.de/service/platform/misc/v1.0";

      async function getSkinAnalysisResult(
        scanId,
        pollId,
        SA_APP_ID,
        SA_BEARER,
      ) {
        // Your example:
        // /plugins/skinAnalysis/scans/<scanId>/<pollId>
        const url = `${SA_BASE}/sa-predictions/apps/${SA_APP_ID}/plugins/skinAnalysis/scans/${scanId}/${pollId}`;

        const res = await fetch(url, {
          method: "GET",
          headers: {
            accept: "application/json, text/plain, */*",
            authorization: `Bearer ${SA_BEARER}`,
          },
        });

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`GET failed ${res.status}: ${text}`);
        }

        return res.json();
      }

      async function pollSkinAnalysis(
        scanId,
        pollId,
        appId,
        SA_BEARER,
        { intervalMs = 2500, maxAttempts = 120 } = {},
      ) {
        for (let attempt = 1; attempt <= maxAttempts; attempt++) {
          const data = await getSkinAnalysisResult(
            scanId,
            pollId,
            appId,
            SA_BEARER,
          );

          const status = data?.status || data?.data?.status; // depending on API shape
          console.log(`‚è≥ poll #${attempt}`, status, data);

          if (status === "SUCCESS") return data;
          if (status === "FAILURE")
            throw new Error(`Polling FAILURE: ${JSON.stringify(data)}`);

          await new Promise((r) => setTimeout(r, intervalMs));
        }

        throw new Error(`Polling timeout after ${maxAttempts} attempts`);
      }

      function buildSkinSummary(finalRes) {
        const out = finalRes?.output || finalRes?.data?.output || finalRes;

        // tweak these paths to match your real response
        const skinType = out?.skinData?.skin_type ?? out?.skin_type;
        const concerns = out?.skinData?.concerns ?? out?.concerns;

        const concernsText = Array.isArray(concerns)
          ? concerns
              .slice(0, 3)
              .map((c) => `‚Ä¢ ${c?.name ?? c}`)
              .join("\n")
          : concerns
            ? String(concerns)
            : "N/A";

        return [
          "‚úÖ Skin analysis completed",
          skinType ? `Skin type: ${skinType}` : null,
          `Top concerns:\n${concernsText}`,
        ]
          .filter(Boolean)
          .join("\n\n");
      }

      /* -------------------------
       * Boot
       * ------------------------- */
      window.addEventListener("DOMContentLoaded", function () {
        copilot(
          "init",
          { element: "copilotSA", position: "initial" },
          function () {
            console.log("‚úÖ Copilot ready");

            // Button click inside chat -> open overlay
            copilot.callbacks.add({
              name: "open_glamar",
              handler: (args) => {
                console.log("‚ûï open_glamar clicked:", args);
                showGlamARSdk();
                return { success: true };
              },
            });

            // Components renderer: launcher + (optional) image card
            copilot.callbacks.add({
              name: "tool:components",
              handler: () => {
                const root = document.createElement("div");

                // --- Launcher card ---
                const launcher = document.createElement("div");
                launcher.innerHTML = `
                  <div style="
                    max-width: 560px;
                    margin: 12px 0;
                    border: 1px solid #ddd;
                    border-radius: 10px;
                    padding: 14px;
                    background: #f8f9fa;
                    display:flex;
                    align-items:center;
                    justify-content:space-between;
                    gap:12px;
                  ">
                    <div>
                      <div style="font-weight:600;">Open GlamAR</div>
                      <div style="font-size:12px;opacity:0.75;margin-top:4px;">
                        Tap + to launch the experience
                      </div>
                    </div>

                    <button
                      data-callback-name="open_glamar"
                      data-callback-args='{"source":"kaily_plus_button"}'
                      style="
                        width:44px;
                        height:44px;
                        border-radius:999px;
                        border:none;
                        font-size:26px;
                        cursor:pointer;
                        box-shadow:0 8px 18px rgba(0,0,0,0.18);
                      "
                      aria-label="Open GlamAR"
                      title="Open GlamAR"
                    >+</button>
                  </div>
                `;
                root.appendChild(launcher);

                // --- SkinGPT image card if pending ---
                const pending = window.__PENDING_SKIN_GPT_IMAGE__;
                if (pending?.src) {
                  const imgCard = document.createElement("div");
                  imgCard.innerHTML = `
                    <div style="
                      max-width:560px;
                      margin:12px 0;
                      border:1px solid #ddd;
                      border-radius:10px;
                      padding:14px;
                      background:#fff;
                    ">
                      <div style="font-weight:600;margin-bottom:10px;">Captured image</div>
                      <img
                        src="${pending.src}"
                        style="width:100%;border-radius:10px;display:block;"
                      />
                    </div>
                  `;
                  root.appendChild(imgCard);

                  // Clear so it renders once
                  window.__PENDING_SKIN_GPT_IMAGE__ = null;
                }

                // Stable id: updates the same component thread
                return { id: "glamar-components-root", content: root };
              },
            });

            // Trigger launcher render
            if (!window.__LAUNCHER_REQUESTED__) {
              window.__LAUNCHER_REQUESTED__ = true;
              copilot("event", "sendUserMessage", {
                value: "Show GlamAR launcher",
              });
            }
          },
        );
      });
    </script>
  </head>

  <body>
    <div id="copilotContainer">
      <div id="copilotSA"></div>
    </div>
  </body>
</html>
