<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkinGPT | GlamAR</title>

    <style>
      /* ---------- Design tokens (tuned to match reference) ---------- */
      :root {
        /* Page */
        --c-page: #ffffff;
        --c-glow-blue: rgba(115, 165, 255, 0.18);
        --c-glow-violet: rgba(170, 120, 255, 0.18);
        --c-glow-pink: rgba(255, 170, 220, 0.1);

        --c-glow-blue-dark: rgba(115, 165, 255, 0.4);
        --c-glow-violet-dark: rgba(170, 120, 255, 0.25);

        /* Brand title */
        --c-title: #4d73ff;
        --c-subtitle: rgba(77, 115, 255, 0.75);

        /* Text */
        --c-text: #0b0b10;
        --c-muted: rgba(11, 11, 16, 0.55);

        /* Panel */
        --c-panel-border: rgba(170, 170, 190, 0.35);
        --c-panel-shadow: rgba(65, 55, 160, 0.1);

        /* Composer */
        --c-focus-ring: rgba(120, 150, 255, 0.22);

        /* Chips */
        --c-chip: rgba(105, 145, 255, 0.18);
        --c-chip-text: rgba(11, 11, 16, 0.78);

        /* Send */
        --c-send-bg: rgba(11, 11, 16, 0.06);
        --c-send-border: rgba(11, 11, 16, 0.08);
        --c-send-icon: rgba(11, 11, 16, 0.6);

        /* Lavender band behind cards */
        --c-band: rgba(160, 140, 255, 0.16);

        /* Cards */
        --c-card: rgba(255, 255, 255, 0.92);
        --c-card-border: rgba(190, 190, 210, 0.4);
        --c-card-shadow: rgba(65, 55, 160, 0.08);

        /* Radii */
        --r-panel: 1.35rem;
        --r-lg: 1.1rem;
        --r-md: 0.9rem;
        --r-pill: 999rem;

        /* Mobile layout helper */
        --mobile-composer-space: 6.25rem; /* fixed bottom bar + gap */
      }

      /* ---------- Base (mobile-first: 320x640) ---------- */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        color: var(--c-text);

        /* No scrolling */
        height: 100svh;
        overflow: hidden;
        overscroll-behavior: none;

        background: var(--c-page);
        background-image:
          radial-gradient(
            70rem 45rem at 20% 18%,
            var(--c-glow-blue),
            transparent 62%
          ),
          radial-gradient(
            70rem 45rem at 80% 22%,
            var(--c-glow-pink),
            transparent 62%
          ),
          radial-gradient(
            80rem 55rem at 50% 88%,
            var(--c-glow-violet),
            transparent 68%
          );
      }

      /* MOBILE: grid to keep title centered + cards just above fixed composer */
      main {
        height: 100%;
        width: 100%;
        display: grid;
        grid-template-rows: 1fr auto;
        align-items: end;
        padding: calc(env(safe-area-inset-top) + 1rem) 1rem
          calc(env(safe-area-inset-bottom) + var(--mobile-composer-space)) 1rem;
        gap: 1rem;
        min-height: 0;
        position: relative;
      }

      .hero-wrap {
        grid-row: 1;
        align-self: center;
        justify-self: center;
        text-align: center;
        pointer-events: none;
      }

      .hero-title {
        margin: 0;
        font-size: 3rem;
        font-weight: 500;
        line-height: 1.02;
        letter-spacing: -0.02em;
        color: var(--c-title);
      }

      .hero-subtitle {
        margin: 0;
        font-size: 0.75rem;
        line-height: 1rem;
        text-align: center;
        color: var(--c-subtitle);
      }

      /* Panel becomes a plain container on mobile */
      .panel {
        grid-row: 2;
        width: 100%;
        border: 0;
        background: transparent;
        box-shadow: none;
        border-radius: 0;
        overflow: visible;
      }

      /* MOBILE: move the EXISTING composer to bottom-fixed (no duplicate textarea) */
      .panel-inner {
        position: fixed;
        left: 0;
        bottom: 0;
        z-index: 6;
        background: white;
        padding: 1rem;
        width: 100%;
      }

      .composer-inner {
        width: 100%;
        border: 0;
        border-radius: 1.35rem;
        background: rgba(11, 11, 16, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 0.3rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .composer-input {
        width: 100%;
        resize: none;
        border: 0;
        outline: none;
        background: transparent;

        font-size: 0.875rem; /* mobile placeholder size */
        line-height: 1.15;
        color: rgba(11, 11, 16, 0.78);

        height: 2.4rem;
        max-height: 3rem;
        overflow: hidden;
        align-content: center;
        overflow-y: auto; /* enables vertical scrolling */
        overflow-x: hidden; /* disables horizontal scrolling */
      }

      .composer-input::placeholder {
        color: rgba(11, 11, 16, 0.38);
      }

      /* chips hidden on mobile ref */
      .chips {
        display: none;
      }

      .composer-bottom {
        display: contents;
      }

      /* CTA default = inactive */
      .cta {
        width: 2.05rem;
        height: 2.05rem;
        border-radius: var(--r-pill);
        background: rgba(11, 11, 16, 0.1);
        border: 0.0625rem solid rgba(11, 11, 16, 0.14);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex: 0 0 auto;
        transition:
          background 180ms ease,
          border-color 180ms ease;
      }

      .cta[disabled],
      .cta.is-disabled {
        opacity: 1;
        cursor: default;
      }

      .cta.is-active {
        background: #0b0b10;
        border-color: #0b0b10;
      }

      .cta svg {
        width: 1.2rem;
        height: 1.2rem;
        color: rgba(11, 11, 16, 0.6);
        transition: color 180ms ease;
      }

      .cta.is-active svg {
        color: #ffffff;
      }

      /* Cards area sits just above composer due to main padding-bottom */
      .panel-band {
        padding: 0;
      }

      .features-container {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        align-items: stretch;
        height: 13rem;
      }

      .feature-card {
        background: rgba(255, 255, 255, 0.74);

        border-radius: 1.55rem;
        overflow: hidden;
        cursor: pointer;
        transition:
          transform 220ms ease,
          box-shadow 220ms ease,
          border-color 220ms ease;
        will-change: transform, box-shadow;
      }

      .feature-card-texts {
        position: absolute;
        width: 100%;
        bottom: 0px;
        padding: 1rem;

        /* display: flex; */
        /* flex-direction: row; */
        background: linear-gradient(
          180deg,
          rgb(255 255 255 / 0%) 0%,
          rgb(255 255 255) 30%
        );
      }

      .feature-card:hover {
        transform: translateY(-0.18rem);
        box-shadow:
          0 1.8rem 3.6rem -2.2rem rgba(65, 55, 160, 0.14),
          0 0.75rem 1.6rem -1.2rem rgba(65, 55, 160, 0.1);
      }

      .feature-card:focus-visible {
        outline: none;
        box-shadow:
          0 0 0 0.25rem var(--c-focus-ring),
          0 1.8rem 3.6rem -2.2rem rgba(65, 55, 160, 0.14);
      }

      .feature-card:active {
        transform: translateY(-0.06rem) scale(0.995);
      }

      .feature-image {
        width: 100%;
        height: 100%;

        border-radius: 1.15rem;
        object-fit: contain;
        display: block;
        padding: 0;
        margin-bottom: 0.85rem;
      }

      .feature-title {
        margin: 0;
        font-size: 0.875rem;
        line-height: 1.25rem;
        letter-spacing: -0.02em;
        color: rgba(11, 11, 16, 0.55);
      }
      .feature-title b {
        margin: 0;
        font-size: 0.875rem;
        line-height: 1.25rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: rgba(11, 11, 16, 0.85);
      }

      /* Skin Portrait pill (mobile: fixed top-left, smaller like ref) */
      .skin-portrait-pill {
        position: fixed;
        top: calc(env(safe-area-inset-top) + 1rem);
        left: 1rem;
        z-index: 7;

        display: inline-flex;
        align-items: center;
        gap: 0.55rem;
        padding: 0.1rem 1rem 0.1rem 0.1rem;
        border-radius: var(--r-pill);
        text-decoration: none;
        color: rgba(11, 11, 16, 0.78);

        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: none;
        background: linear-gradient(
          120deg,
          #c7666699 0%,
          rgb(255 255 255 / 30%) 0%,
          rgb(255 255 255) 100%
        );
      }

      .skin-portrait-plus {
        width: 2.12rem;
        height: 2.12rem;
        border-radius: var(--r-pill);
        background: rgba(255, 255, 255, 0.92);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex: 0 0 auto;
        overflow: hidden;
      }

      .portrait-image {
        display: none;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .skin-portrait-pill:hover {
        background: linear-gradient(
          120deg,
          var(--c-glow-blue) 50%,
          var(--c-glow-violet) 100%
        );
      }

      .skin-portrait-plus svg {
        width: 1rem;
        height: 1rem;
        color: rgba(11, 11, 16, 0.6);
      }

      .skin-portrait-text {
        font-size: 0.75rem;
        font-weight: 500;
        letter-spacing: -0.03em;
        line-height: 1rem;
        color: rgba(11, 11, 16, 0.72);
      }

      /* ---------- Copilot / Overlay (keep yours) ---------- */
      #copilotContainer {
        position: fixed;
        inset: 0;
        z-index: 10;
        background: #fff;
        display: flex;
      }
      #copilotSA {
        width: 100%;
        height: 100%;
      }
      #glamarOverlay {
        position: fixed;
        inset: 0;
        z-index: 999999;
        background: rgba(0, 0, 0, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
      }
      #glamarModal {
        position: relative;
        width: 100%;
        height: 100%;
        background: #fff;

        overflow: hidden;
      }
      #GlamAR-Container {
        width: 100%;
        height: 100%;
        background: #fff;
        overflow: hidden;
      }

      .loader {
        width: 100%;
        height: 100%;
        background: #00000052;
        position: fixed;
        z-index: 1000000;
        display: none;
        align-items: center;
        justify-content: center;
      }
      .loader.active {
        display: flex;
      }
      .loader svg {
        max-width: 200px;
        max-height: 200px;
      }

      /* ===================== NEW: Skin Portrait Screen styles (REM based) ===================== */
      .sp-screen {
        width: 100%;
        height: 100%;
        position: fixed;
        inset: 0;
        z-index: 50;
        display: none;
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(0.625rem);
        -webkit-backdrop-filter: blur(0.625rem);
        max-width: 42rem;
        justify-self: center;
      }

      .sp-screen.is-open {
        display: block;
      }

      .sp-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 3.5rem; /* 56px */
        align-items: center;
        background: white;
        z-index: 500;
        display: flex;
        padding: 1rem;
      }

      .sp-back {
        position: absolute;
        width: 2.5rem; /* 40px */
        height: 2.5rem;
        border-radius: 999rem;
        border: 0;
        background: rgba(11, 11, 16, 0.06);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .sp-back svg {
        width: 1.125rem; /* 18px */
        height: 1.125rem;
        color: rgba(11, 11, 16, 0.75);
      }

      .sp-title {
        position: absolute;
        justify-self: anchor-center;
        text-align: center;
        font-weight: 500;
        color: rgba(11, 11, 16, 0.88);
        font-size: 0.875rem; /* 14px */
      }

      .sp-add {
        justify-self: end;
        width: 3.375rem; /* 54px */
        height: 2.375rem; /* 38px */
        border-radius: 999rem;
        border: 0;
        cursor: pointer;
        background: #2256ff;
        color: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        right: 0;
        top: 0;
      }

      .sp-add svg {
        width: 1.125rem;
        height: 1.125rem;
      }

      .sp-content {
        overflow: auto;
        padding: 1.125rem;
        height: 100%;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        padding-top: 5rem;
        padding-bottom: 5rem;
        gap: 1rem;
        min-height: 0;
        position: relative;
      }

      .sp-title-content {
        position: relative;
        width: 100%;
      }

      .sp-h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 500;
        letter-spacing: -0.02em;
        line-height: 1.5;
      }

      .sp-grid {
        position: relative;
        isolation: isolate;
        max-width: 100%;
        margin-bottom: 1.125rem;
        display: none;
      }
      .sp-card-scroller {
        display: flex;
        gap: 0.5rem;
        flex-direction: row;
        overflow: hidden;
        overflow-x: auto;
      }

      .sp-card {
        min-width: 11.25rem;
        width: 11.25rem;
        height: 15rem;
        border-radius: 0.875rem;
        background: rgba(11, 11, 16, 0.06);
        aspect-ratio: 1 / 1;
        overflow: hidden;
        position: relative;
      }

      .sp-card-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      /* top-right 3-dot button */
      .sp-card-more {
        position: absolute;
        right: 0.625rem; /* 10px */
        top: 0.625rem;
        width: 2rem;
        height: 2rem;
        border-radius: 999rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(0.25rem);
        cursor: pointer;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.06);
      }

      /* bottom time pill */
      .sp-card-footer {
        position: absolute;
        left: 0.7rem;
        bottom: 0.7rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem; /* 6px 12px */
        border-radius: 1rem;
        background: rgba(11, 11, 16, 0.28);
        color: #fff;
        backdrop-filter: blur(0.1rem);
        font-size: 0.875rem;
      }

      /* small clock icon inside footer (SVG scaled) */
      .sp-card-footer svg {
        width: 1rem;
        height: 1rem;
        opacity: 0.95;
        flex: 0 0 auto;
      }

      .sp-h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 500;
        letter-spacing: -0.02em;
        line-height: 1.5;
      }

      .sp-sub {
        margin: 0 0 0.75rem;
        font-size: 1rem;
        color: rgba(11, 11, 16, 0.55);
      }

      .sp-chips {
        display: flex;
        gap: 0.625rem; /* 10px */
        flex-wrap: wrap;
        margin-bottom: 1.125rem;
      }

      .sp-chip {
        display: inline-flex;
        align-items: center;
        padding: 0.625rem 0.875rem; /* 10px 14px */
        border-radius: 999rem;
        background: rgba(255, 140, 140, 0.18);
        color: rgba(11, 11, 16, 0.85);
        font-weight: 500;
        font-size: 0.875rem;
      }

      .sp-questions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .sp-q {
        width: fit-content;
        max-width: 100%;
        padding: 1rem 1.125rem; /* 16px 18px */
        border-radius: 1.125rem; /* 18px */
        background: rgba(190, 205, 255, 0.32);
        border: 0;
        color: rgba(11, 11, 16, 0.85);
        font-size: 1rem;
        cursor: pointer;
      }

      /* ===================== Analysis Banner ===================== */

      .analysis-banner {
        position: relative;
        isolation: isolate;

        height: 15rem; /* 240px */
        min-height: 15rem;
        width: 100%;
        border-radius: 1rem;
        overflow: hidden;

        background: #f2f6ff;
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;

        display: flex;
        align-items: flex-end;
        background-image: url("https://storage.googleapis.com/skinchat-core-dev-releases-asia-east1/0.6.0/br/dist/immutable/assets/face.CjJRPTSQ.png");
      }

      /* bottom gradient overlay */
      .analysis-banner::before {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 40%;
        z-index: -1;

        background: linear-gradient(
          to bottom,
          rgba(245, 249, 255, 0) 0%,
          #f5f9ff 100%
        );
      }

      /* ===================== Analyze Button ===================== */

      .analysis-btn {
        position: absolute;
        left: 0.75rem;
        right: 0.75rem;
        bottom: 0.75rem;

        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;

        min-height: 2.5rem;
        padding: 0.625rem 1.5rem;

        border: 0;
        border-radius: 1.25rem;

        background: #ffffff;
        color: #0b0b10;

        font-size: 0.875rem;
        font-weight: 500;
        letter-spacing: -0.02em;

        cursor: pointer;
        transition: background 0.15s ease;
      }

      /* subtle hover overlay */
      .analysis-btn::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: #000;
        opacity: 0;
        transition: opacity 0.15s ease;
      }

      .analysis-btn:hover::before {
        opacity: 0.03;
      }

      /* keep content above hover overlay */
      .analysis-btn > * {
        position: relative;
        z-index: 1;
      }

      /* ===================== Icon ===================== */

      .analysis-btn-icon {
        width: 1.25rem;
        height: 1.25rem;
        background-color: currentColor;

        -webkit-mask: url("https://storage.googleapis.com/skinchat-core-dev-releases-asia-east1/0.6.0/br/dist/immutable/assets/frame.Zb3spE2D.svg")
          center / contain no-repeat;
        mask: url("https://storage.googleapis.com/skinchat-core-dev-releases-asia-east1/0.6.0/br/dist/immutable/assets/frame.Zb3spE2D.svg")
          center / contain no-repeat;
      }

      /* ===================== NEW: Skin Portrait Result Screen (REM based) ===================== */
      .sr-screen {
        position: fixed;
        inset: 0;
        z-index: 60; /* above sp-screen(50), below glam overlay(999999) */
        display: none;
        background: white;
        width: 100%;
        height: 100%;
        max-width: 42rem;
        justify-self: anchor-center;
      }

      .sr-screen.is-open {
        display: block;
      }

      .sr-top {
        position: relative;
        top: 0;
        left: 0;
        width: 100%;
        height: 3.5rem; /* 56px */
        align-items: center;
        background: white;
        z-index: 500;
        display: flex;
        padding: 1rem;
      }

      .sr-back {
        position: absolute;
        left: 1rem;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 999rem;
        border: 0;
        background: rgba(11, 11, 16, 0.06);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .sr-back svg {
        width: 1.125rem;
        height: 1.125rem;
        color: rgba(11, 11, 16, 0.75);
      }

      .sr-time {
        position: absolute;
        font-size: 1.25rem;
        font-weight: 600;
        letter-spacing: -0.02em;
        color: rgba(11, 11, 16, 0.88);
        position: absolute;
        justify-self: anchor-center;
      }

      .sr-content {
        height: 100%;
        overflow: auto;
        padding: 1.125rem;
        padding-top: 2rem;
        padding-bottom: 5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .sr-card {
        background: rgba(255, 255, 255, 0.98);
        border: 0.0625rem solid rgba(11, 11, 16, 0.08);
        border-radius: 1.25rem;
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .sr-row {
        padding: 1.5rem;
      }

      .sr-kv {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .sr-k {
        font-size: 1.125rem;
        color: rgba(11, 11, 16, 0.82);
        letter-spacing: -0.02em;
      }

      .sr-v {
        font-size: 1.125rem;
        font-weight: 700;
        color: rgba(11, 11, 16, 0.9);
        letter-spacing: -0.02em;
      }

      .sr-v-lg {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .sr-grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
      }

      .sr-tone-top {
        display: flex;
        align-items: center;
        justify-content: flex-start;
      }

      .sr-tone-label {
        font-size: 1.25rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: rgba(11, 11, 16, 0.9);
      }

      .sr-tone-track {
        height: 0.5rem;
        border-radius: 999rem;

        background-image: linear-gradient(
          90deg,
          #faf3f7,
          #f1e2eb 26.27%,
          #f2c7ac 49.62%,
          #7b645a 73.89%,
          #31141d
        );
        position: relative;
      }

      .sr-tone-thumb {
        position: absolute;
        top: 50%;
        left: 25%;
        transform: translate(-50%, -50%);
        width: 0.35rem;
        height: 1.1rem;
        border-radius: 0.35rem;
        background: #0b0b10;
        box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.8);
      }

      .sr-tone-bottom {
        display: flex;
        align-items: center;
        justify-content: flex-start;
      }

      .sr-tone-k {
        font-size: 1.25rem;
        letter-spacing: -0.02em;
        color: rgba(11, 11, 16, 0.88);
      }

      .sr-h2 {
        font-size: 1.5rem;
        font-weight: 800;
        letter-spacing: -0.03em;
        color: rgba(11, 11, 16, 0.9);
      }

      .sr-sub {
        margin-top: 0.25rem;
        font-size: 1.25rem;
        line-height: 1.35;
        letter-spacing: -0.02em;
        color: rgba(11, 11, 16, 0.75);
      }

      .sr-tags {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .sr-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.85rem 1.1rem;
        border-radius: 999rem;
        background: rgba(226, 244, 228, 0.8);
        color: rgba(11, 11, 16, 0.85);
        font-size: 1rem;
        letter-spacing: -0.02em;
      }

      .sr-tag svg {
        width: 1.2rem;
        height: 1.2rem;
        opacity: 0.55;
      }

      /* --- Carousel --- */
      .sr-carousel-wrap {
        position: relative;
        margin-top: 1.25rem;
      }

      .sr-carousel {
        display: flex;
        gap: 0.75rem;
        overflow-x: auto;
        padding-bottom: 0.25rem;
        scroll-snap-type: x mandatory;
      }

      .sr-next {
        position: absolute;
        right: 0.6rem;
        top: 50%;
        transform: translateY(-50%);
        width: 2.6rem;
        height: 2.6rem;
        border-radius: 999rem;
        border: 0;
        background: rgba(11, 11, 16, 0.55);
        color: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .sr-next svg {
        width: 1.1rem;
        height: 1.1rem;
      }

      .sr-concern-card {
        flex: 0 0 auto;
        width: 16.25rem;
        border-radius: 1.5rem;
        border: 0.0625rem solid rgba(11, 11, 16, 0.08);
        background: #fff;
        overflow: hidden;
        scroll-snap-align: start;
      }

      .sr-concern-img {
        width: 100%;
        height: 15.5rem;
        object-fit: cover;
        display: block;
      }

      .sr-concern-bottom {
        background: rgba(255, 255, 255, 0.96);
        padding: 1rem;
        border-top: 0.0625rem solid rgba(11, 11, 16, 0.06);
      }

      .sr-concern-title-row {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
      }

      .sr-concern-name {
        font-size: 1.5rem;
        font-weight: 800;
        letter-spacing: -0.03em;
        color: rgba(11, 11, 16, 0.92);
        line-height: 1.1;
      }

      .sr-concern-sev {
        margin-top: 0.35rem;
        font-size: 1.125rem;
        color: rgba(255, 120, 45, 0.95); /* orange like ref */
        letter-spacing: -0.02em;
      }

      .sr-score {
        width: 3.3rem;
        height: 3.3rem;
        border-radius: 999rem;
        background: conic-gradient(
          #f5b62a calc(var(--p) * 1%),
          rgba(11, 11, 16, 0.08) 0
        );
        display: grid;
        place-items: center;
        flex: 0 0 auto;
      }

      .sr-score-inner {
        width: 2.7rem;
        height: 2.7rem;
        border-radius: 999rem;
        background: #fff;
        display: grid;
        place-items: center;
        border: 0.0625rem solid rgba(11, 11, 16, 0.06);
        line-height: 1.05;
        letter-spacing: -0.02em;
      }

      .sr-score-inner .sr-score-top {
        font-weight: 800;
        font-size: 1rem;
        color: rgba(11, 11, 16, 0.9);
      }

      .sr-score-inner .sr-score-bot {
        font-size: 0.85rem;
        color: rgba(11, 11, 16, 0.65);
      }

      .sr-show-more {
        margin-top: 0.9rem;
        width: 100%;
        border: 0;
        border-radius: 999rem;
        padding: 0.85rem 1rem;
        font-size: 1.1rem;
        letter-spacing: -0.02em;
        background: #2856d4;
        color: #fff;
        cursor: pointer;
      }

      /* Summary paragraph */
      .sr-summary {
        margin-top: 1.25rem;
        font-size: 1.25rem;
        line-height: 1.5;
        letter-spacing: -0.02em;
        color: rgba(11, 11, 16, 0.82);
        white-space: pre-wrap;
      }

      /* ===================== Concern Screen ===================== */
      .cs-screen {
        position: fixed;
        inset: 0;
        z-index: 70; /* above sr-screen (60) */
        display: none;
        width: 100%;
        height: 100%;
        background: #c9c3f975;
      }

      .cs-root {
        max-width: 42rem;
        justify-self: center;
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
      }

      .cs-screen.is-open {
        display: block;
      }

      /* Desktop header (shown on >=648px) */
      .cs-top {
        display: none;
        position: relative;
        height: 3.5rem;
        padding: 1rem;
        align-items: center;
        background: #fff;
      }

      .cs-back {
        position: absolute;
        left: 1rem;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 999rem;
        border: 0;
        background: rgba(11, 11, 16, 0.06);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .cs-back svg {
        width: 1.125rem;
        height: 1.125rem;
        color: rgba(11, 11, 16, 0.75);
      }

      .cs-title {
        width: 100%;
        text-align: center;
        font-size: 1rem;
        font-weight: 600;
        letter-spacing: -0.02em;
        color: rgba(11, 11, 16, 0.9);
      }

      /* Hero image */
      .cs-hero {
        position: relative;
        width: 100%;
        height: 44vh;
        min-height: 18rem;
        background: #f2f2f4;
        overflow: hidden;
      }

      .cs-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      /* Mobile close button on image */
      .cs-close {
        position: absolute;
        right: 1rem;
        top: 1rem;
        width: 3rem;
        height: 3rem;
        border-radius: 999rem;
        border: 0;
        background: rgba(11, 11, 16, 0.25);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .cs-close svg {
        width: 1.25rem;
        height: 1.25rem;
        color: #fff;
      }

      /* Sheet */
      .cs-sheet {
        height: calc(100% - 44vh);
        overflow: auto;
        background: #fff;
        padding: 1.25rem;
      }

      /* Tabs row */
      .cs-tabs {
        display: flex;
        gap: 0.75rem;
        overflow-x: auto;
        padding-bottom: 0.75rem;
        -webkit-overflow-scrolling: touch;
      }

      .cs-tab {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        border: 0;
        cursor: pointer;
        padding: 0.9rem 1.15rem;
        border-radius: 1rem;
        background: rgba(11, 11, 16, 0.06);
        color: rgba(11, 11, 16, 0.85);
        font-size: 1.05rem;
        letter-spacing: -0.02em;
        white-space: nowrap;
      }

      .cs-tab svg {
        width: 1.25rem;
        height: 1.25rem;
        opacity: 0.7;
      }

      .cs-tab.is-active {
        background: #1f56ff;
        color: #fff;
      }

      .cs-tab.is-active svg {
        opacity: 1;
      }

      /* Heading */
      .cs-heading {
        padding-top: 0.25rem;
      }

      .cs-heading-row {
        display: flex;
        align-items: baseline;
        gap: 0.6rem;
      }

      .cs-name {
        font-size: 2rem;
        font-weight: 700;
        letter-spacing: -0.03em;
        color: rgba(11, 11, 16, 0.92);
      }

      .cs-sev {
        font-size: 1.35rem;
        font-weight: 600;
        color: rgba(11, 11, 16, 0.35);
        letter-spacing: -0.02em;
      }

      .cs-score-row {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
        margin-top: 0.35rem;
      }

      .cs-score {
        font-size: 2.5rem;
        font-weight: 700;
        letter-spacing: -0.03em;
        color: rgba(11, 11, 16, 0.92);
      }

      .cs-score-den {
        font-size: 1.1rem;
        font-weight: 600;
        color: rgba(11, 11, 16, 0.35);
      }

      .cs-bar {
        margin-top: 1rem;
        height: 0.75rem;
        border-radius: 999rem;
        background: rgba(11, 11, 16, 0.06);
        overflow: hidden;
      }

      .cs-bar-fill {
        height: 100%;
        width: 0%;
        border-radius: 999rem;
        background: #f5b62a;
        transition: width 220ms ease;
      }

      .cs-desc {
        margin-top: 1.25rem;
        font-size: 1.25rem;
        line-height: 1.6;
        letter-spacing: -0.02em;
        color: rgba(11, 11, 16, 0.82);
        padding-bottom: 2rem;
        white-space: pre-wrap;
      }

      /* ---------- Required media queries ---------- */

      @media (min-width: 648px) {
        /* Desktop/tablet layout (your current look) */
        main {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 1.75rem 1.5rem;
          gap: 3rem;
        }

        .hero-wrap {
          position: static;
          grid-row: auto;
          align-self: auto;
          justify-self: auto;
          pointer-events: auto;
        }

        .panel {
          width: 100%;
          max-width: 38rem;
          border-radius: var(--r-panel);
          border: 0.0625rem solid var(--c-panel-border);
          box-shadow: 0 1.5rem 3.2rem -2rem var(--c-panel-shadow);
          overflow: hidden;
          background: linear-gradient(
            180deg,
            transparent 0%,
            rgba(160, 140, 255, 0.08) 2%,
            var(--c-band) 100%
          );
        }

        /* composer back inside panel */
        .panel-inner {
          position: static;
          left: auto;
          right: auto;
          bottom: auto;
          z-index: auto;
          display: flex;
          flex-direction: column;
          gap: 1rem;
          width: auto;
          padding: 0;
          background: transparent;
        }

        .composer-inner {
          border-bottom: 0.0625rem solid rgba(190, 190, 210, 0.45);
          border-radius: var(--r-lg);
          background: rgba(255, 255, 255, 0.9);
          padding: 0.95rem;
          display: grid;
          grid-template-rows: auto auto;
          gap: 2.4rem;
          backdrop-filter: none;
          -webkit-backdrop-filter: none;
        }

        .composer-bottom {
          display: grid;
          grid-template-columns: 1fr auto;
          gap: 0.9rem;
          align-items: end;
        }

        .chips {
          display: flex;
          flex-direction: row;
          gap: 0.55rem;
          align-items: flex-start;
          min-width: 0;
        }

        .suggestion-btn {
          background: var(--c-chip);
          border: 0;
          color: var(--c-chip-text);
          padding: 0.45rem 0.95rem;
          border-radius: var(--r-pill);
          font-size: 0.875rem;
          line-height: 1.25rem;
          cursor: pointer;
          max-width: 100%;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .suggestion-btn:hover {
          background: linear-gradient(
            120deg,
            var(--c-glow-blue-dark) 50%,
            var(--c-glow-violet-dark) 100%
          );
        }

        .composer-input {
          font-size: 0.875rem;
          line-height: 1.25rem;
          letter-spacing: -0.02em;
          height: auto;
          max-height: 7.6rem;
          overflow-y: auto;
        }

        .panel-band {
          padding: 1rem;
        }

        .features-container {
          grid-template-columns: 1fr 1fr;
          gap: 0.5rem;
        }

        .feature-card {
          background: var(--c-card);

          border-radius: var(--r-lg);
          box-shadow: 0 1.2rem 2.4rem -2rem var(--c-card-shadow);
        }

        .feature-image {
          border-radius: var(--r-md);
          padding: 0.35rem;
        }

        .feature-description {
          font-size: 0.92rem;
        }

        /* Skin Portrait back below panel (not fixed) */
        .skin-portrait-pill {
          position: static;
          top: auto;
          left: auto;
          z-index: auto;

          gap: 0.7rem;
          padding: 0.1rem 1rem 0.1rem 0.1rem;
          border-radius: var(--r-pill);
          box-shadow: 0 1.4rem 2.8rem -2.2rem rgba(65, 55, 160, 0.12);
          background: linear-gradient(
            120deg,
            #c7666699 0%,
            rgb(255 255 255 / 30%) 0%,
            rgb(255 255 255) 100%
          );
          backdrop-filter: none;
          -webkit-backdrop-filter: none;
        }

        .skin-portrait-pill:hover {
          background: linear-gradient(
            120deg,
            var(--c-glow-blue) 50%,
            var(--c-glow-violet) 100%
          );
        }

        .skin-portrait-plus {
          width: 2.5rem;
          height: 2.5rem;
          background: white;
        }

        .cta {
          background: var(--c-send-bg);
          border-color: var(--c-send-border);
        }

        .cta svg {
          width: 1.15rem;
          height: 1.15rem;
        }

        .sr-content {
          padding-left: 1.5rem;
          padding-right: 1.5rem;
        }

        .sr-concern-card {
          width: 18.75rem;
        }

        .sr-concern-img {
          height: 17.5rem;
        }

        .cs-top {
          display: flex;
        }

        .cs-close {
          display: none; /* use back in header */
        }

        .cs-hero {
          height: auto;
          min-height: 0;
          padding: 1rem 1.5rem 0;
          background: #fff;
        }

        .cs-image {
          height: 22rem;
          border-radius: 1.25rem;
          object-fit: cover;
        }

        .cs-sheet {
          height: calc(100% - 3.5rem - 22rem - 1rem);
          padding: 1.25rem 1.5rem 2rem;
        }

        .cs-tabs {
          padding-top: 0.5rem;
        }
      }
    </style>
  </head>

  <body>
    <div id="loader" class="loader"></div>

    <main>
      <div class="hero-wrap">
        <h1 class="hero-title">SkinGPT</h1>
        <p class="hero-subtitle">Your AI skincare assistant</p>
      </div>

      <div class="panel">
        <div class="panel-inner">
          <div class="composer">
            <div class="composer-inner">
              <textarea
                class="composer-input"
                rows="1"
                placeholder="How can I help you today?"
              ></textarea>

              <div class="composer-bottom">
                <div class="chips">
                  <button class="suggestion-btn" type="button">
                    How do I improve my skin texture?
                  </button>
                  <button class="suggestion-btn" type="button">
                    Recommend a good moisturizer
                  </button>
                </div>

                <button class="cta" type="button" aria-label="Send">
                  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path
                      d="M12 5v14m0-14l-6 6m6-6l6 6"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="panel-band">
          <div class="features-container">
            <div class="feature-card" id="analyze" role="button" tabindex="0">
              <img
                class="feature-image"
                id="analyzeImg"
                src="https://storage.googleapis.com/skinchat-core-dev-releases-asia-east1/0.5.1/br/dist/immutable/assets/analysis.ZSryxJbS.png"
                alt=""
              />
              <div class="feature-card-texts">
                <span class="feature-title">
                  <b>Analyze my skin</b>
                  by taking a quick photo
                </span>
              </div>
            </div>

            <div
              class="feature-card"
              id="personalise"
              role="button"
              tabindex="0"
            >
              <img
                class="feature-image"
                id="personaliseImg"
                src="https://storage.googleapis.com/skinchat-core-dev-releases-asia-east1/0.5.1/br/dist/immutable/assets/routine.CBHeyKkM.png"
                alt=""
              />
              <div class="feature-card-texts">
                <span class="feature-title">
                  Build my personalized <b>skincare routine</b>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <a
        href="/skin-portrait"
        class="skin-portrait-pill"
        aria-label="Skin Portrait"
      >
        <span class="skin-portrait-plus" aria-hidden="true">
          <svg id="portrait-plus" viewBox="0 0 24 24" fill="none">
            <path
              d="M12 5v14M5 12h14"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
          <img
            class="portrait-image"
            id="portrait-image"
            src=""
            alt=""
            referrerpolicy="no-referrer"
          />
        </span>
        <span class="skin-portrait-text">Skin Portrait</span>
      </a>
    </main>

    <div id="copilotContainer"><div id="copilotSA"></div></div>
    <!-- ===================== NEW: Skin Portrait Screen ===================== -->
    <section id="skinPortraitScreen" class="sp-screen" aria-hidden="true">
      <div class="sp-header">
        <button class="sp-back" id="spBackBtn" type="button" aria-label="Back">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path
              d="M15 18l-6-6 6-6"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>

        <div class="sp-title">Skin Portrait</div>

        <!-- <button class="sp-add" id="spAddBtn" type="button" aria-label="Add">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path
              d="M12 5v14M5 12h14"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
        </button> -->
      </div>

      <div class="sp-content">
        <div class="sp-title-content">
          <h2 class="sp-h2">Your skin analysis</h2>
          <button class="sp-add" id="spAddBtn" type="button" aria-label="Add">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path
                d="M12 5v14M5 12h14"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>

        <div class="sp-grid" id="spGrid">
          <div class="sp-card-scroller" id="cardScroller"></div>
        </div>
        <div class="analysis-banner">
          <button class="analysis-btn" id="analyzeBannerBtn" type="button">
            <span class="analysis-btn-icon" aria-hidden="true"></span>
            <span class="analysis-btn-text">Analyze</span>
          </button>
        </div>

        <div class="sp-concerns">
          <h3 class="sp-h3">Let's support your skin!</h3>
          <p class="sp-sub">These areas could benefit from extra care:</p>

          <div class="sp-chips">
            <span class="sp-chip" id="spChip1">Pores</span>
            <span class="sp-chip" id="spChip2">Hydration</span>
            <span class="sp-chip" id="spChip3">Uniformness</span>
          </div>
        </div>

        <div class="sp-questions-info">
          <h3 class="sp-h3">Have a skin concern?</h3>
          <p class="sp-sub">Start with a question!</p>
        </div>

        <div class="sp-questions">
          <button class="sp-q" type="button">What's my skin type?</button>
          <button class="sp-q" type="button">
            What skincare suits me best?
          </button>
          <button class="sp-q" type="button">Ask more...</button>
        </div>
      </div>
    </section>

    <!-- ===================== NEW: Skin Portrait Result Screen ===================== -->
    <section id="skinPortraitResultScreen" class="sr-screen" aria-hidden="true">
      <!-- Top bar -->
      <div class="sr-top">
        <button class="sr-back" id="srBackBtn" type="button" aria-label="Back">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path
              d="M15 18l-6-6 6-6"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>

        <div class="sr-time" id="srTime">—</div>
      </div>

      <div class="sr-content">
        <!-- Summary cards -->
        <div class="sr-card sr-row">
          <div class="sr-kv">
            <div class="sr-k">Skin type</div>
            <div class="sr-v" id="srSkinType">—</div>
          </div>
        </div>

        <div class="sr-grid2">
          <div class="sr-card">
            <div class="sr-k">Perceived age</div>
            <div class="sr-v sr-v-lg" id="srSkinAge">—</div>
          </div>

          <div class="sr-card">
            <div class="sr-k">Eye age</div>
            <div class="sr-v sr-v-lg" id="srEyeAge">—</div>
          </div>
        </div>

        <div class="sr-card">
          <div class="sr-tone-top">
            <div class="sr-tone-label" id="srToneLabel">Light</div>
          </div>

          <div class="sr-tone-track" aria-hidden="true">
            <div class="sr-tone-thumb" id="srToneThumb"></div>
          </div>

          <div class="sr-tone-bottom">
            <div class="sr-tone-k">Skin tone</div>
          </div>
        </div>

        <!-- “Your skin looks great!” block -->
        <div class="sr-block">
          <div class="sr-h2">Your skin looks great!</div>
          <div class="sr-sub">These parameters are in excellent condition:</div>

          <div class="sr-tags" id="srTags"></div>
        </div>

        <!-- Concern cards (image + footer + score + show more) -->
        <div class="sr-carousel-wrap">
          <div class="sr-carousel" id="srCarousel"></div>

          <button
            class="sr-next"
            id="srNextBtn"
            type="button"
            aria-label="Next"
          >
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path
                d="M9 6l6 6-6 6"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </button>
        </div>

        <!-- Summary paragraph -->
        <div class="sr-summary" id="srSummary"></div>
      </div>
    </section>

    <!-- ===================== NEW: Concern Screen ===================== -->
    <section id="concernScreen" class="cs-screen" aria-hidden="true">
      <div class="cs-root">
        <!-- Desktop header -->
        <div class="cs-top">
          <button
            class="cs-back"
            id="csBackBtn"
            type="button"
            aria-label="Back"
          >
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path
                d="M15 18l-6-6 6-6"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </button>
          <div class="cs-title" id="csHeaderTitle">Concern</div>
        </div>

        <!-- Image area -->
        <div class="cs-hero">
          <img id="csImage" class="cs-image" alt="Concern image" />
          <!-- Mobile close -->
          <button
            class="cs-close"
            id="csCloseBtn"
            type="button"
            aria-label="Close"
          >
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path
                d="M6 6l12 12M18 6L6 18"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>

        <!-- Sheet/content -->
        <div class="cs-sheet">
          <!-- Tabs -->
          <div class="cs-tabs" id="csTabs"></div>

          <!-- Title + severity -->
          <div class="cs-heading">
            <div class="cs-heading-row">
              <div class="cs-name" id="csName">—</div>
              <div class="cs-sev" id="csSeverity">—</div>
            </div>

            <div class="cs-score-row">
              <div class="cs-score" id="csScore">—</div>
              <div class="cs-score-den">/ 100</div>
            </div>

            <div class="cs-bar">
              <div class="cs-bar-fill" id="csBarFill"></div>
            </div>
          </div>

          <!-- Description -->
          <div class="cs-desc" id="csDesc"></div>
        </div>
      </div>
    </section>

    <script src="https://cdn.glamarz0.de/sdk/wrapper?=@1.2.8.js"></script>
    <script src="https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js"></script>

    <script type="application/javascript">
      let isCopilotInitialized = false;
      const SA_BASE = "https://api.pixelbinz0.de/service/platform/misc/v1.0";
      const appId = "fecf3bc7-c9ec-4c47-8555-98a74df58288";
      const accessKey = "ba843e66-4b93-48f6-a02e-ea48d920e52e";
      const accessToken = "f235570c-1fab-466f-95e7-597315095e3e";
      const LS_KEY_ID = "GLAMAR_SA:user_id";
      const ALPHABET =
        "useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"; // nanoid default-ish
      const SIZE = 21;
      let subjectId = null;
      let currentScanId = null;
      const userId = getOrCreateAnonymousUserId();
      // For SP chips -> Concern screen
      let __SP_SELECTED_CONCERNS__ = [];

      const onBoardingQuestions = [
        "What skincare routine should I start with?",
        "What are today's best deals?",
        "What should I use for dark circles?",
        "How do I improve my skin texture?",
        "How can I help you today?",
        "Which products are best for glowing skin?",
        "Help me choose products for oily skin",
        "How can I reduce dryness?",
        "Recommend a good moisturizer",
        "How can I prevent premature aging?",
        "How can I reduce dark spots and pigmentation?",
        "How can I treat active acne and prevent new breakouts?",
      ];

      function getRandomTwo(arr) {
        const shuffled = [...arr].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, 2);
      }

      function setRandomSuggestions() {
        const buttons = document.querySelectorAll(".suggestion-btn");
        const randomQuestions = getRandomTwo(onBoardingQuestions);

        buttons.forEach((btn, index) => {
          if (randomQuestions[index]) {
            btn.textContent = randomQuestions[index];
          }
        });
      }
      setRandomSuggestions();

      (function () {
        const qButtons = document.querySelectorAll("#skinPortraitScreen .sp-q");
        if (!qButtons || qButtons.length < 3) return;

        const q1 = qButtons[0];
        const q2 = qButtons[1];
        const qAskMore = qButtons[2];

        function setRandomSPQuestions() {
          const [a, b] = getRandomTwo(onBoardingQuestions);
          if (a) q1.textContent = a;
          if (b) q2.textContent = b;
          // Ask more stays as-is
        }

        async function openCopilotAndSend(text) {
          closeSkinPortraitScreen();
          await showCopilot(); // will no-op if already initialized
          window?.copilot?.("event", "sendUserMessage", { value: text });
        }

        async function openCopilotOnly() {
          closeSkinPortraitScreen();
          await showCopilot();
        }

        // Set random questions on load
        setRandomSPQuestions();

        // Optional: refresh random questions every time screen opens
        // (If you prefer only once per page load, remove this listener)
        const spScreen = document.getElementById("skinPortraitScreen");
        if (spScreen) {
          const observer = new MutationObserver(() => {
            if (spScreen.classList.contains("is-open")) setRandomSPQuestions();
          });
          observer.observe(spScreen, {
            attributes: true,
            attributeFilter: ["class"],
          });
        }

        // Click handlers
        q1.addEventListener("click", () =>
          openCopilotAndSend(q1.textContent.trim()),
        );
        q2.addEventListener("click", () =>
          openCopilotAndSend(q2.textContent.trim()),
        );
        qAskMore.addEventListener("click", openCopilotOnly);
      })();

      (async () => {
        try {
          const res = await getSubjectId(appId, userId, accessToken);
          console.log(res.subjectId);
          subjectId = res.subjectId;
          getPastScans();
        } catch (e) {
          console.error("getSubjectId failed:", e);
        }
      })();

      // convert ISO created_at to "X hours/days ago" friendly text
      function timeAgo(iso) {
        if (!iso) return "";
        const then = new Date(iso);
        const now = new Date();
        const diff = Math.floor((now - then) / 1000); // seconds

        const mins = Math.floor(diff / 60);
        if (mins < 1) return "just now";
        if (mins < 60)
          return `${mins} ${mins === 1 ? "minute" : "minutes"} ago`;

        const hours = Math.floor(mins / 60);
        if (hours < 24) return `${hours} ${hours === 1 ? "hour" : "hours"} ago`;

        const days = Math.floor(hours / 24);
        if (days < 7) return `${days} ${days === 1 ? "day" : "days"} ago`;

        // fallback: show date
        return then.toLocaleDateString();
      }

      function openSkinPortraitResultScreen() {
        const sr = document.getElementById("skinPortraitResultScreen");
        if (!sr) return;
        sr.classList.add("is-open");
        sr.setAttribute("aria-hidden", "false");
      }

      function closeSkinPortraitResultScreen() {
        const sr = document.getElementById("skinPortraitResultScreen");
        if (!sr) return;
        sr.classList.remove("is-open");
        sr.setAttribute("aria-hidden", "true");
      }

      function setToneUI(skinTone) {
        const label = document.getElementById("srToneLabel");
        const thumb = document.getElementById("srToneThumb");
        if (!label || !thumb) return;

        const tone = (skinTone || "").toString().trim();
        label.textContent = tone || "Light";

        // map tone -> thumb position (approx, stable)
        const map = {
          "Very Light": 10,
          Light: 25,
          Medium: 50,
          Tan: 70,
          Deep: 85,
          Dark: 88,
        };

        let pct = map[tone];
        if (typeof pct !== "number") {
          // fallback: if unknown, keep mid
          pct = 50;
        }
        thumb.style.left = pct + "%";
      }

      function iconForTag(name) {
        // generic icons (simple + lightweight)
        const n = (name || "").toLowerCase();
        if (n.includes("hydr")) {
          return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3s6 6.4 6 11.1A6 6 0 1 1 6 14.1C6 9.4 12 3 12 3z" stroke="currentColor" stroke-width="1.8"/>
        </svg>`;
        }
        if (n.includes("acne") || n.includes("spot")) {
          return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="9" cy="10" r="2.2" stroke="currentColor" stroke-width="1.8"/>
          <circle cx="16" cy="14" r="1.8" stroke="currentColor" stroke-width="1.8"/>
          <path d="M7 17c2.5 2 7.5 2 10 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        </svg>`;
        }
        if (n.includes("eye")) {
          return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M2.5 12s3.5-6.5 9.5-6.5 9.5 6.5 9.5 6.5-3.5 6.5-9.5 6.5S2.5 12 2.5 12z" stroke="currentColor" stroke-width="1.8"/>
          <circle cx="12" cy="12" r="2.5" stroke="currentColor" stroke-width="1.8"/>
        </svg>`;
        }
        return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M7 14c2-3 8-3 10 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        <path d="M6 10c1.5-2 10.5-2 12 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
      </svg>`;
      }

      function renderResultScreenFromItem(item) {
        const skinData = item?.report_data?.output?.skinData || {};
        const concerns = Array.isArray(skinData?.concerns)
          ? skinData.concerns
          : [];

        const createdAt =
          item?.report_data?.createdAt || item?.created_at || item?.updated_at;

        const srTime = document.getElementById("srTime");
        const srSkinType = document.getElementById("srSkinType");
        const srSkinAge = document.getElementById("srSkinAge");
        const srEyeAge = document.getElementById("srEyeAge");
        const srTags = document.getElementById("srTags");
        const srCarousel = document.getElementById("srCarousel");
        const srSummary = document.getElementById("srSummary");

        if (srTime) srTime.textContent = timeAgo(createdAt);
        if (srSkinType) srSkinType.textContent = skinData?.skin_type || "—";
        if (srSkinAge)
          srSkinAge.textContent = Number.isFinite(skinData?.skin_age)
            ? skinData.skin_age
            : "—";
        if (srEyeAge)
          srEyeAge.textContent = Number.isFinite(skinData?.eye_age)
            ? skinData.eye_age
            : "—";

        setToneUI(skinData?.skin_tone);
        setToneThumbFromToneLabel(skinData?.skin_tone);

        // tags (use first 6 concerns as “excellent condition” pills like reference)
        if (srTags) {
          srTags.innerHTML = "";
          const topTags = concerns
            .slice(0, 6)
            .map((c) => c?.name)
            .filter(Boolean);
          topTags.forEach((name) => {
            const el = document.createElement("div");
            el.className = "sr-tag";
            el.innerHTML = `${iconForTag(name)}<span>${name}</span>`;
            srTags.appendChild(el);
          });
        }

        // carousel (use first 2 concerns like reference)
        if (srCarousel) {
          srCarousel.innerHTML = "";
          // const top2 = concerns.slice(0, 2);

          concerns.forEach((c) => {
            const value = Math.max(0, Math.min(100, Number(c?.value ?? 0)));
            const sev = (c?.severity || "").toString().trim() || "—";

            const card = document.createElement("div");
            card.className = "sr-concern-card";

            const img = document.createElement("img");
            img.className = "sr-concern-img";
            img.src = c?.image || "";
            img.alt = c?.name || "Concern";
            img.loading = "lazy";
            img.referrerPolicy = "no-referrer";

            const bottom = document.createElement("div");
            bottom.className = "sr-concern-bottom";

            bottom.innerHTML = `
            <div class="sr-concern-title-row">
              <div>
                <div class="sr-concern-name">${c?.name || "—"}</div>
                <div class="sr-concern-sev">${sev}</div>
              </div>

              <div class="sr-score" style="--p:${value}">
                <div class="sr-score-inner">
                  <div class="sr-score-top">${value}</div>
                  <div class="sr-score-bot">100</div>
                </div>
              </div>
            </div>

            <button class="sr-show-more" type="button">Show more</button>
          `;

            bottom
              .querySelector(".sr-show-more")
              ?.addEventListener("click", (ev) => {
                ev.stopPropagation();
                openConcernScreenFor(concerns, c?.name);
              });

            card.appendChild(img);
            card.appendChild(bottom);
            srCarousel.appendChild(card);
          });
        }

        // summary paragraph
        if (srSummary) {
          srSummary.textContent = skinData?.summary || "";
        }
      }

      function normalizeToneLabel(s) {
        return String(s || "")
          .trim()
          .toLowerCase();
      }

      function tonePosFor(label) {
        const l = normalizeToneLabel(label);

        const map = {
          "very fair": 12,
          fair: 22,
          light: 28,
          intermediate: 35,
          medium: 45,
          tan: 60,
          deep: 78,
          dark: 82,
          "very deep": 88,
        };

        if (map[l] != null) return map[l];

        // allow numeric tones too (0..100)
        const n = Number(label);
        if (Number.isFinite(n)) return Math.max(0, Math.min(100, n));

        return 35; // default fallback
      }

      function setToneThumbFromToneLabel(toneLabel) {
        const thumb = document.getElementById("srToneThumb");
        if (!thumb) return;

        const pct = tonePosFor(toneLabel);
        thumb.style.left = pct + "%";
      }

      // render cards into .sp-grid from items (keeps up to limit)
      function renderScansCards(items = [], limit = 10) {
        const cardScroller = document.getElementById("cardScroller");
        const grid = document.getElementById("spGrid");
        const analysisBanner = document.querySelector(".analysis-banner");
        if (!cardScroller) return;
        cardScroller.innerHTML = "";

        const valid = items.filter((it) => {
          const url = it?.report_data?.input?.image;
          return typeof url === "string" && url.trim();
        });

        const toRender = valid.slice(0, limit);

        let selectedIndex = 0; // default: first card selected

        function setSelected(index) {
          selectedIndex = index;

          // optional: if you later want a visual selected state, add/remove a class here
          // [...grid.children].forEach((el, i) => el.classList.toggle("is-selected", i === index));

          const selectedItem = toRender[index];
          if (selectedItem) setConcernChipsFromItem(selectedItem);
        }

        toRender.forEach((it, idx) => {
          const imageUrl = it.report_data.input.image;
          const createdAt = it.report_data.createdAt || it.created_at;

          const card = document.createElement("div");
          card.className = "sp-card";

          // Store item reference on DOM node for later use if needed
          card.__scanItem = it;

          const img = document.createElement("img");
          img.className = "sp-card-img";
          img.src = imageUrl;
          img.alt = "skin portrait";
          img.loading = "lazy";
          img.referrerPolicy = "no-referrer";

          img.onerror = function () {
            img.style.display = "none";
            card.style.background = "linear-gradient(180deg, #f2f2f4, #e9e9ee)";
          };

          const moreBtn = document.createElement("button");
          moreBtn.className = "sp-card-more";
          moreBtn.type = "button";
          moreBtn.title = "More";
          moreBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="5" cy="12" r="1.5" fill="rgba(11,11,16,0.7)"></circle>
            <circle cx="12" cy="12" r="1.5" fill="rgba(11,11,16,0.7)"></circle>
            <circle cx="19" cy="12" r="1.5" fill="rgba(11,11,16,0.7)"></circle>
          </svg>
        `;

          const footer = document.createElement("div");
          footer.className = "sp-card-footer";
          footer.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 7v6l4 2" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="12" r="9" stroke="white" stroke-width="1.2" fill="none"/>
          </svg>
          <span>${timeAgo(createdAt)}</span>
        `;

          card.addEventListener("click", (e) => {
            if (e.target.closest(".sp-card-more")) return;

            setSelected(idx); // keeps your chips update behavior
            renderResultScreenFromItem(it); // fill result UI from this scan
            openSkinPortraitResultScreen(); // open result overlay
          });

          moreBtn.addEventListener("click", (ev) => {
            ev.stopPropagation();
            console.log("more clicked for", it);
          });

          card.appendChild(img);
          // card.appendChild(moreBtn);
          card.appendChild(footer);
          cardScroller.appendChild(card);
        });

        // Default selection when user lands
        if (toRender.length) {
          setSelected(0);
          grid.style.display = "block";
          analysisBanner.style.display = "none";
        }
      }

      // ===================== Concern Screen state =====================
      let __CURRENT_CONCERNS__ = [];
      let __CURRENT_CONCERN_INDEX__ = 0;

      function openConcernScreen() {
        const cs = document.getElementById("concernScreen");
        if (!cs) return;
        cs.classList.add("is-open");
        cs.setAttribute("aria-hidden", "false");
      }

      function closeConcernScreen() {
        const cs = document.getElementById("concernScreen");
        if (!cs) return;
        cs.classList.remove("is-open");
        cs.setAttribute("aria-hidden", "true");
      }

      function normalizeConcernName(s) {
        return String(s || "")
          .trim()
          .toLowerCase();
      }

      // If your API already provides severity, we use it.
      // Otherwise we derive a reasonable label.
      function severityFromValue(v) {
        const n = Number(v);
        if (!Number.isFinite(n)) return "—";
        if (n >= 80) return "Excellent";
        if (n >= 65) return "Good";
        if (n >= 45) return "Average";
        if (n >= 25) return "Needs care";
        return "Poor";
      }

      // Optional: tiny inline icon (you can customize per concern name)
      function iconForConcernTab(name) {
        const n = normalizeConcernName(name);

        if (n.includes("red")) {
          return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3s6 6.4 6 11.1A6 6 0 1 1 6 14.1C6 9.4 12 3 12 3z"
            stroke="currentColor" stroke-width="1.8"/>
        </svg>`;
        }

        if (n.includes("pore")) {
          return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="8" cy="9" r="1.6" fill="currentColor" opacity="0.75"/>
          <circle cx="14" cy="12" r="1.6" fill="currentColor" opacity="0.75"/>
          <circle cx="10" cy="15" r="1.6" fill="currentColor" opacity="0.75"/>
        </svg>`;
        }

        if (n.includes("line") || n.includes("wrinkle")) {
          return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 9c4-3 12-3 16 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M5 14c3-2 11-2 14 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" opacity="0.85"/>
        </svg>`;
        }

        return `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.8"/>
      </svg>`;
      }

      function renderConcernScreen(index) {
        const concerns = Array.isArray(__CURRENT_CONCERNS__)
          ? __CURRENT_CONCERNS__
          : [];
        if (!concerns.length) return;

        const safeIndex = Math.max(0, Math.min(concerns.length - 1, index));
        __CURRENT_CONCERN_INDEX__ = safeIndex;

        const c = concerns[safeIndex] || {};
        const name = c?.name || "Concern";
        const value = Math.max(0, Math.min(100, Number(c?.value ?? 0)));
        const severity =
          String(c?.severity || "").trim() || severityFromValue(value);

        const img = document.getElementById("csImage");
        const headerTitle = document.getElementById("csHeaderTitle");
        const csName = document.getElementById("csName");
        const csSeverity = document.getElementById("csSeverity");
        const csScore = document.getElementById("csScore");
        const csBarFill = document.getElementById("csBarFill");
        const csDesc = document.getElementById("csDesc");
        const csTabs = document.getElementById("csTabs");

        if (headerTitle) headerTitle.textContent = name;

        // image: prefer concern image; fallback to empty
        if (img) {
          img.src = c?.image || "";
          img.alt = name;
          img.referrerPolicy = "no-referrer";
          img.loading = "lazy";
          img.onerror = () => {
            img.removeAttribute("src");
            img.style.background = "linear-gradient(180deg, #f2f2f4, #e9e9ee)";
          };
        }

        if (csName) csName.textContent = name + ":";
        if (csSeverity) csSeverity.textContent = severity;
        if (csScore) csScore.textContent = String(Math.round(value));
        if (csBarFill) csBarFill.style.width = value + "%";

        // description: adapt to your schema if you have a specific key
        const desc =
          c?.description ||
          c?.info ||
          c?.details ||
          c?.summary ||
          "No additional information available for this concern.";
        if (csDesc) csDesc.textContent = desc;

        // tabs
        if (csTabs) {
          csTabs.innerHTML = "";
          concerns.forEach((it, i) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "cs-tab" + (i === safeIndex ? " is-active" : "");
            btn.innerHTML = `${iconForConcernTab(it?.name)}<span>${it?.name || "—"}</span>`;
            btn.addEventListener("click", () => renderConcernScreen(i));
            csTabs.appendChild(btn);
          });
        }
      }

      function openConcernScreenFor(concerns, selectedConcernName) {
        __CURRENT_CONCERNS__ = Array.isArray(concerns) ? concerns : [];

        const target = normalizeConcernName(selectedConcernName);
        let idx = 0;

        if (target && __CURRENT_CONCERNS__.length) {
          const found = __CURRENT_CONCERNS__.findIndex(
            (c) => normalizeConcernName(c?.name) === target,
          );
          idx = found >= 0 ? found : 0;
        }

        renderConcernScreen(idx);
        openConcernScreen();
      }

      // Wire close/back buttons once
      (function initConcernScreenControls() {
        const csBackBtn = document.getElementById("csBackBtn");
        const csCloseBtn = document.getElementById("csCloseBtn");
        if (csBackBtn) csBackBtn.addEventListener("click", closeConcernScreen);
        if (csCloseBtn)
          csCloseBtn.addEventListener("click", closeConcernScreen);

        window.addEventListener("keydown", (e) => {
          const cs = document.getElementById("concernScreen");
          if (e.key === "Escape" && cs?.classList.contains("is-open")) {
            closeConcernScreen();
          }
        });
      })();

      function getTop3ConcernNames(item) {
        const concerns = item?.report_data?.output?.skinData?.concerns || [];
        return concerns
          .map((c) => (typeof c?.name === "string" ? c.name.trim() : ""))
          .filter(Boolean)
          .slice(0, 3);
      }

      function setConcernChipsFromItem(item) {
        const chips = [
          document.getElementById("spChip1"),
          document.getElementById("spChip2"),
          document.getElementById("spChip3"),
        ].filter(Boolean);

        if (!chips.length) return;

        // ✅ store current scan concerns so chips can open concern screen
        const concerns = Array.isArray(
          item?.report_data?.output?.skinData?.concerns,
        )
          ? item.report_data.output.skinData.concerns
          : [];
        __SP_SELECTED_CONCERNS__ = concerns;

        const top3 = getTop3ConcernNames(item);

        // keep 3 chips static; fallback to existing labels if missing
        const labels = [
          top3[0] || chips[0].textContent || "Pores",
          top3[1] || chips[1].textContent || "Hydration",
          top3[2] || chips[2].textContent || "Uniformness",
        ];

        chips.forEach((chip, idx) => {
          chip.textContent = labels[idx];

          // ✅ make it look/behave like a button (once)
          chip.setAttribute("role", "button");
          chip.setAttribute("tabindex", "0");
          chip.style.cursor = "pointer";

          // avoid duplicate listeners
          if (chip.__boundConcernClick) return;
          chip.__boundConcernClick = true;

          const openFromChip = () => {
            const name = chip.textContent.trim();
            if (!name) return;
            openConcernScreenFor(__SP_SELECTED_CONCERNS__, name);
          };

          chip.addEventListener("click", openFromChip);
          chip.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              openFromChip();
            }
          });
        });
      }

      async function getPastScans() {
        if (subjectId) {
          try {
            const res = await getScans(appId, subjectId, accessToken);
            console.log("getScans result:", res);

            const items = res?.items || [];
            const portraitPlus = document.getElementById("portrait-plus");
            const portraitImage = document.getElementById("portrait-image");

            // find first valid image for portrait pill (existing behavior)
            for (let i = 0; i < Math.min(items.length, 10); i++) {
              const imageUrl = items[i]?.report_data?.input?.image;
              if (typeof imageUrl === "string" && imageUrl.trim()) {
                portraitImage.style.display = "block";
                portraitPlus.style.display = "none";
                portraitImage.src = imageUrl;
                break;
              }
            }

            // now render all valid items as cards in the SP grid
            renderScansCards(items, 10);
          } catch (e) {
            console.error("getScans failed:", e);
          }
        }
      }

      async function kailyShowMore(tech) {
        if (subjectId && currentScanId) {
          try {
            const res = await getSingleScan(
              appId,
              subjectId,
              currentScanId,
              accessToken,
            );
            console.log("getsingleScans result:", res);
            let concerns = res?.report_data?.output?.skinData?.concerns;
            if (concerns) {
              const selected =
                concerns.find(
                  (c) =>
                    String(c.tech_name).toLowerCase() === tech.toLowerCase(),
                ) ||
                console.log("parse concerns JSON", concerns, tech, selected);
              // your existing concern screen opener
              openConcernScreenFor(concerns, selected?.name || name);
            }
          } catch (e) {
            console.error("getsingleScans failed:", e);
          }
        }
      }

      const loader = document.getElementById("loader");
      let loaderAnimation = null;

      function initLoader() {
        if (!loader || loaderAnimation) return;

        loaderAnimation = lottie.loadAnimation({
          container: loader,
          renderer: "svg",
          loop: true,
          autoplay: true,
          width: "200px",
          height: "200px",
          path: "https://cdn.pixelbin.io/v2/dummy-cloudname/original/__glam_ar/__sdk/saloader_light.json",
        });
      }

      function showLoader() {
        initLoader();
        document.getElementById("loader")?.classList.add("active");
      }

      function hideLoader() {
        document.getElementById("loader")?.classList.remove("active");
      }

      async function showCopilot(
        userSettings = {
          hostId: "1234",
          email: "example@gmail.com",
          additionalFields: { onBoardingQuestions },
        },
      ) {
        if (isCopilotInitialized) return true;
        let copilotReady = false;
        showLoader();
        copilotContainer.style.display = "flex";

        (function (w, d, s, o, f, js, fjs) {
          w[o] =
            w[o] ||
            function () {
              (w[o].q = w[o].q || []).push(arguments);
            };
          js = d.createElement(s);
          fjs = d.getElementsByTagName(s)[0];
          js.id = o;
          js.src = f;
          js.async = 1;
          js.referrerPolicy = "origin";
          fjs.parentNode.insertBefore(js, fjs);
        })(
          window,
          document,
          "script",
          "copilot",
          "https://script.copilot.live/v1/copilot.min.js?tkn=cat-pnxlzhq8",
        );

        copilot(
          "init",
          { element: "copilotSA", position: "initial" },
          function () {
            try {
              window?.copilot?.users?.set?.(userSettings);
            } catch (e) {
              console.warn("users.set failed:", e);
            }
            copilotReady = true;
            hideLoader();

            try {
              window?.copilot.callbacks.add({
                name: "open_glamar",
                handler: (args) => {
                  console.log("open_glamar clicked", args);
                  showGlamARSdk();
                  return { success: true };
                },
              });
            } catch (e) {
              console.warn("open_glamar callback attachment failed", e);
            }

            try {
              window?.copilot?.callbacks?.add({
                name: "open_concern",
                handler: (args) => {
                  console.log("open_concern called", args);
                  const tech = String(args?.value || "");

                  kailyShowMore(tech);

                  return { success: true };
                },
              });
            } catch (e) {
              console.warn("open_concern callback attachment failed", e);
            }
          },
        );

        while (!copilotReady) {
          await new Promise((resolve) => setTimeout(resolve, 50));
        }
        isCopilotInitialized = true;
        return copilotReady;
      }

      let glamAROverlay = null;
      let glamARContainer = null;

      const copilotContainer = document.getElementById("copilotContainer");
      const analyzeBtn = document.getElementById("analyze");
      const analyzeBannerBtn = document.getElementById("analyzeBannerBtn");

      const spAddBtn = document.getElementById("spAddBtn");
      const personaliseBtn = document.getElementById("personalise");
      const textarea = document.querySelector(".composer-input");
      const chips = document.querySelectorAll(".suggestion-btn");
      const sendBtn = document.querySelector(".cta");

      copilotContainer.style.display = "none";

      const autosize = () => {
        textarea.style.height = "auto";
        const maxH = parseFloat(getComputedStyle(textarea).maxHeight || "9999");
        textarea.style.height = Math.min(textarea.scrollHeight, maxH) + "px";
      };

      const setSendState = () => {
        const hasText = textarea.value.trim().length > 0;
        sendBtn.classList.toggle("is-active", hasText);
        sendBtn.classList.toggle("is-disabled", !hasText);
        sendBtn.disabled = !hasText;
      };

      // ===================== NEW: Skin Portrait Screen wiring =====================
      (function () {
        const skinPortraitPill = document.querySelector(".skin-portrait-pill");
        const spScreen = document.getElementById("skinPortraitScreen");
        const spBackBtn = document.getElementById("spBackBtn");

        if (!skinPortraitPill || !spScreen || !spBackBtn) return;

        function openSP() {
          spScreen.classList.add("is-open");
          spScreen.setAttribute("aria-hidden", "false");
        }

        function closeSP() {
          spScreen.classList.remove("is-open");
          spScreen.setAttribute("aria-hidden", "true");
        }

        // Open new screen on Skin Portrait pill click
        skinPortraitPill.addEventListener("click", (e) => {
          // If you still want to navigate to /skin-portrait later, remove this preventDefault
          e.preventDefault();
          openSP();
        });

        // Back
        spBackBtn.addEventListener("click", closeSP);

        // Optional: close on ESC (desktop)
        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && spScreen.classList.contains("is-open"))
            closeSP();
        });
      })();

      function closeSkinPortraitScreen() {
        const spScreen = document.getElementById("skinPortraitScreen");
        if (!spScreen) return;
        spScreen.classList.remove("is-open");
        spScreen.setAttribute("aria-hidden", "true");
      }

      (function () {
        const srBackBtn = document.getElementById("srBackBtn");
        const srNextBtn = document.getElementById("srNextBtn");
        const srCarousel = document.getElementById("srCarousel");
        if (srBackBtn)
          srBackBtn.addEventListener("click", closeSkinPortraitResultScreen);

        // next button just scrolls the carousel
        if (srNextBtn && srCarousel) {
          srNextBtn.addEventListener("click", () => {
            srCarousel.scrollBy({
              left: srCarousel.clientWidth * 0.85,
              behavior: "smooth",
            });
          });
        }
      })();

      autosize();
      setSendState();

      textarea.addEventListener("input", () => {
        autosize();
        setSendState();
      });

      chips.forEach((btn) => {
        btn.addEventListener("click", () => {
          textarea.value = btn.textContent.trim();
          textarea.focus();
          autosize();
          setSendState();
        });
      });

      personaliseBtn.addEventListener("click", async () => {
        await showCopilot();
        copilot("event", "sendUserMessage", {
          value: "Build my personalized skincare routine",
        });
      });

      sendBtn.addEventListener("click", async () => {
        const message = textarea.value.trim();
        if (!message) return;

        await showCopilot();
        copilot("event", "sendUserMessage", { value: message });

        textarea.value = "";
        textarea.style.height = "auto";
        setSendState();
      });

      analyzeBtn.addEventListener("click", () => {
        showGlamARSdk();
      });
      analyzeBannerBtn.addEventListener("click", () => {
        closeSkinPortraitScreen();
        showGlamARSdk();
      });
      spAddBtn.addEventListener("click", () => {
        closeSkinPortraitScreen();
        showGlamARSdk();
      });

      function ensureOverlay() {
        if (document.getElementById("glamarOverlay")) {
          glamAROverlay = document.getElementById("glamarOverlay");
          glamARContainer = document.getElementById("GlamAR-Container");
          return;
        }

        const overlay = document.createElement("div");
        overlay.id = "glamarOverlay";
        overlay.innerHTML = `
               <div id="glamarModal">
                 <div id="GlamAR-Container"></div>
                 <button id="closeSdkBtn" aria-label="Close">×</button>
               </div>
             `;
        document.body.appendChild(overlay);

        glamAROverlay = overlay;
        glamARContainer = document.getElementById("GlamAR-Container");
      }

      function showGlamARSdk() {
        ensureOverlay();
        glamAROverlay.style.display = "flex";
        initGlamAr();
      }

      function closeGlamARSdk() {
        try {
          if (window.GlamAR && typeof window.GlamAR.close === "function")
            window.GlamAR.close();
        } catch (e) {}
        if (glamAROverlay) glamAROverlay.style.display = "none";
        if (glamARContainer)
          while (glamARContainer.firstChild)
            glamARContainer.removeChild(glamARContainer.firstChild);
        window.__GLAMAR_INITIALIZED__ = false;
      }

      function initGlamAr() {
        ensureOverlay();
        glamAROverlay.style.display = "flex";

        if (window.__GLAMAR_INITIALIZED__) return;
        if (!window.GlamAR || typeof window.GlamAR.init !== "function") {
          console.error("GlamAR wrapper missing");
          return;
        }
        showLoader();

        window.__GLAMAR_INITIALIZED__ = true;

        const config = {
          platform: "web",
          category: "skingpt",
          meta: { sdkVersion: "2.0.0" },
          configuration: {
            skinAnalysis: {
              appId: appId,
              userId: userId,
            },
          },
        };

        window.GlamAR.init("GlamAR-Container", accessKey, config);

        window.GlamAR.addEventListener?.("*", async (event, payload) => {
          if (event === "loading") hideLoader();
          if (event === "closed") closeGlamARSdk();

          if (event === "skin-gpt") {
            try {
              const {
                accessToken,
                scanId,
                predictionId,
                appId,
                subjectId,
                retouchPredictionId,
                currencySymbols,
              } = payload || {};
              console.log("result", payload);

              const userSettings = {
                hostId: scanId,
                email: "example@gmail.com",
                additionalFields: {
                  predictionId,
                  scanId,
                  retouchPredictionId,
                  accessToken,
                  appId,
                  currencySymbols,
                  onBoardingQuestions,
                  subjectId,
                },
              };

              if (!isCopilotInitialized) await showCopilot(userSettings);

              window.copilot.context.set({
                predictionId: predictionId,
                scanId: scanId,
                retouchPredictionId: retouchPredictionId,
                accessToken: accessToken,
                appId: appId,
                currencySymbols: currencySymbols,
                onBoardingQuestions: onBoardingQuestions,
                subjectId: subjectId,
              });

              closeGlamARSdk();
              copilot("event", "sendUserMessage", {
                value: "analyze my skin",
              });
              currentScanId = scanId;
            } catch (e) {
              console.error("Error handling skin-gpt:", e);
            }
          }
        });
      }

      async function getScans(appId, subjectId, SA_BEARER) {
        const url = `${SA_BASE}/apps/${appId}/subjects/${subjectId}/scans?pageNo=1&pageSize=10`;
        const res = await fetch(url, {
          method: "GET",
          headers: {
            accept: "application/json, text/plain, */*",
            authorization: `Bearer ${btoa(unescape(encodeURIComponent(SA_BEARER)))}`,
          },
        });
        if (!res.ok) {
          const t = await res.text().catch(() => "");
          throw new Error(`GET skinAnalysis failed ${res.status}: ${t}`);
        }
        return res.json();
      }

      async function getSingleScan(appId, subjectId, scanId, SA_BEARER) {
        const url = `${SA_BASE}/apps/${appId}/subjects/${subjectId}/scans/${scanId}`;
        const res = await fetch(url, {
          method: "GET",
          headers: {
            accept: "application/json, text/plain, */*",
            authorization: `Bearer ${btoa(unescape(encodeURIComponent(SA_BEARER)))}`,
          },
        });
        if (!res.ok) {
          const t = await res.text().catch(() => "");
          throw new Error(`GET skinAnalysis failed ${res.status}: ${t}`);
        }
        return res.json();
      }

      async function getSubjectId(appId, userId, SA_BEARER) {
        const url = `${SA_BASE}/apps/${appId}/subjects/createSubjectId/${userId}`;
        const res = await fetch(url, {
          method: "GET",
          headers: {
            accept: "application/json, text/plain, */*",
            authorization: `Bearer ${btoa(unescape(encodeURIComponent(SA_BEARER)))}`,
          },
        });
        if (!res.ok) {
          const t = await res.text().catch(() => "");
          throw new Error(`GET subject id failed ${res.status}: ${t}`);
        }
        return res.json();
      }

      function nanoId(size = SIZE) {
        const bytes = new Uint8Array(size);
        crypto.getRandomValues(bytes);

        let id = "";
        for (let i = 0; i < size; i++) {
          id += ALPHABET[bytes[i] & 63]; // 0..63
        }
        return id;
      }

      function getOrCreateAnonymousUserId() {
        try {
          let id = localStorage.getItem(LS_KEY_ID);
          if (id) return id;

          id = nanoId();
          localStorage.setItem(LS_KEY_ID, id);
          return id;
        } catch (e) {
          // If localStorage is blocked (incognito / strict privacy), fall back to per-session id
          return nanoId();
        }
      }

      function clearAnonymousUserId() {
        try {
          localStorage.removeItem(LS_KEY_ID);
        } catch {}
      }
    </script>
  </body>
</html>
