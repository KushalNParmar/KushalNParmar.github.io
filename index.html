<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkinGPT | GlamAR</title>

    <style>
      /* ---------- Design tokens (tuned to match reference) ---------- */
      :root {
        /* Page */
        --c-page: #ffffff;
        --c-glow-blue: rgba(115, 165, 255, 0.18);
        --c-glow-violet: rgba(170, 120, 255, 0.18);
        --c-glow-pink: rgba(255, 170, 220, 0.1);

        --c-glow-blue-dark: rgba(115, 165, 255, 0.4);
        --c-glow-violet-dark: rgba(170, 120, 255, 0.25);

        /* Brand title */
        --c-title: #4d73ff;
        --c-subtitle: rgba(77, 115, 255, 0.75);

        /* Text */
        --c-text: #0b0b10;
        --c-muted: rgba(11, 11, 16, 0.55);

        /* Panel */
        --c-panel-border: rgba(170, 170, 190, 0.35);
        --c-panel-shadow: rgba(65, 55, 160, 0.1);

        /* Composer */
        --c-focus-ring: rgba(120, 150, 255, 0.22);

        /* Chips */
        --c-chip: rgba(105, 145, 255, 0.18);
        --c-chip-text: rgba(11, 11, 16, 0.78);

        /* Send */
        --c-send-bg: rgba(11, 11, 16, 0.06);
        --c-send-border: rgba(11, 11, 16, 0.08);
        --c-send-icon: rgba(11, 11, 16, 0.6);

        /* Lavender band behind cards */
        --c-band: rgba(160, 140, 255, 0.16);

        /* Cards */
        --c-card: rgba(255, 255, 255, 0.92);
        --c-card-border: rgba(190, 190, 210, 0.4);
        --c-card-shadow: rgba(65, 55, 160, 0.08);

        /* Radii */
        --r-panel: 1.35rem;
        --r-lg: 1.1rem;
        --r-md: 0.9rem;
        --r-pill: 999rem;

        /* Mobile layout helper */
        --mobile-composer-space: 6.25rem; /* fixed bottom bar + gap */
      }

      /* ---------- Base (mobile-first: 320x640) ---------- */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        color: var(--c-text);

        /* No scrolling */
        height: 100svh;
        overflow: hidden;
        overscroll-behavior: none;

        background: var(--c-page);
        background-image:
          radial-gradient(
            70rem 45rem at 20% 18%,
            var(--c-glow-blue),
            transparent 62%
          ),
          radial-gradient(
            70rem 45rem at 80% 22%,
            var(--c-glow-pink),
            transparent 62%
          ),
          radial-gradient(
            80rem 55rem at 50% 88%,
            var(--c-glow-violet),
            transparent 68%
          );
      }

      /* MOBILE: grid to keep title centered + cards just above fixed composer */
      main {
        height: 100%;
        width: 100%;
        display: grid;
        grid-template-rows: 1fr auto;
        align-items: end;
        padding: calc(env(safe-area-inset-top) + 1rem) 1rem
          calc(env(safe-area-inset-bottom) + var(--mobile-composer-space)) 1rem;
        gap: 1rem;
        min-height: 0;
        position: relative;
      }

      .hero-wrap {
        grid-row: 1;
        align-self: center;
        justify-self: center;
        text-align: center;
        pointer-events: none;
      }

      .hero-title {
        margin: 0;
        font-size: 3rem;
        font-weight: 500;
        line-height: 1.02;
        letter-spacing: -0.02em;
        color: var(--c-title);
      }

      .hero-subtitle {
        margin: 0;
        font-size: 0.75rem;
        line-height: 1rem;
        text-align: center;
        color: var(--c-subtitle);
      }

      /* Panel becomes a plain container on mobile */
      .panel {
        grid-row: 2;
        width: 100%;
        border: 0;
        background: transparent;
        box-shadow: none;
        border-radius: 0;
        overflow: visible;
      }

      /* MOBILE: move the EXISTING composer to bottom-fixed (no duplicate textarea) */
      .panel-inner {
        position: fixed;
        left: 0;
        bottom: 0;
        z-index: 6;
        background: white;
        padding: 1rem;
        width: 100%;
      }

      .composer-inner {
        width: 100%;
        border: 0;
        border-radius: 1.35rem;
        background: rgba(11, 11, 16, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 0.3rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .composer-input {
        width: 100%;
        resize: none;
        border: 0;
        outline: none;
        background: transparent;

        font-size: 0.875rem; /* mobile placeholder size */
        line-height: 1.15;
        color: rgba(11, 11, 16, 0.78);

        height: 2.4rem;
        max-height: 3rem;
        overflow: hidden;
        align-content: center;
        overflow-y: auto;
      }

      .composer-input::placeholder {
        color: rgba(11, 11, 16, 0.38);
      }

      /* chips hidden on mobile ref */
      .chips {
        display: none;
      }

      .composer-bottom {
        display: contents;
      }

      /* CTA default = inactive */
      .cta {
        width: 2.05rem;
        height: 2.05rem;
        border-radius: var(--r-pill);
        background: rgba(11, 11, 16, 0.1);
        border: 0.0625rem solid rgba(11, 11, 16, 0.14);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex: 0 0 auto;
        transition:
          background 180ms ease,
          border-color 180ms ease;
      }

      .cta[disabled],
      .cta.is-disabled {
        opacity: 1;
        cursor: default;
      }

      .cta.is-active {
        background: #0b0b10;
        border-color: #0b0b10;
      }

      .cta svg {
        width: 1.2rem;
        height: 1.2rem;
        color: rgba(11, 11, 16, 0.6);
        transition: color 180ms ease;
      }

      .cta.is-active svg {
        color: #ffffff;
      }

      /* Cards area sits just above composer due to main padding-bottom */
      .panel-band {
        padding: 0;
      }

      .features-container {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        align-items: stretch;
        height: 13rem;
      }

      .feature-card {
        background: rgba(255, 255, 255, 0.74);

        border-radius: 1.55rem;
        overflow: hidden;
        cursor: pointer;
        transition:
          transform 220ms ease,
          box-shadow 220ms ease,
          border-color 220ms ease;
        will-change: transform, box-shadow;
      }

      .feature-card-texts {
        position: absolute;
        width: 100%;
        bottom: 0px;
        padding: 1rem;

        /* display: flex; */
        /* flex-direction: row; */
        background: linear-gradient(
          180deg,
          rgb(255 255 255 / 0%) 0%,
          rgb(255 255 255) 30%
        );
      }

      .feature-card:hover {
        transform: translateY(-0.18rem);
        box-shadow:
          0 1.8rem 3.6rem -2.2rem rgba(65, 55, 160, 0.14),
          0 0.75rem 1.6rem -1.2rem rgba(65, 55, 160, 0.1);
      }

      .feature-card:focus-visible {
        outline: none;
        box-shadow:
          0 0 0 0.25rem var(--c-focus-ring),
          0 1.8rem 3.6rem -2.2rem rgba(65, 55, 160, 0.14);
      }

      .feature-card:active {
        transform: translateY(-0.06rem) scale(0.995);
      }

      .feature-image {
        width: 100%;
        height: 100%;

        border-radius: 1.15rem;
        object-fit: contain;
        display: block;
        padding: 0;
        margin-bottom: 0.85rem;
      }

      .feature-title {
        margin: 0;
        font-size: 0.875rem;
        line-height: 1.25rem;
        letter-spacing: -0.02em;
        color: rgba(11, 11, 16, 0.55);
      }
      .feature-title b {
        margin: 0;
        font-size: 0.875rem;
        line-height: 1.25rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: rgba(11, 11, 16, 0.85);
      }

      /* Skin Portrait pill (mobile: fixed top-left, smaller like ref) */
      .skin-portrait-pill {
        position: fixed;
        top: calc(env(safe-area-inset-top) + 1rem);
        left: 1rem;
        z-index: 7;

        display: inline-flex;
        align-items: center;
        gap: 0.55rem;
        padding: 0.1rem 1rem 0.1rem 0.1rem;
        border-radius: var(--r-pill);
        text-decoration: none;
        color: rgba(11, 11, 16, 0.78);

        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: none;
        background: linear-gradient(
          120deg,
          #c7666699 0%,
          rgb(255 255 255 / 30%) 0%,
          rgb(255 255 255) 100%
        );
      }

      .skin-portrait-plus {
        width: 2.12rem;
        height: 2.12rem;
        border-radius: var(--r-pill);
        background: rgba(255, 255, 255, 0.92);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex: 0 0 auto;
        overflow: hidden;
      }

      .portrait-image {
        display: none;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .skin-portrait-pill:hover {
        background: linear-gradient(
          120deg,
          var(--c-glow-blue) 50%,
          var(--c-glow-violet) 100%
        );
      }

      .skin-portrait-plus svg {
        width: 1rem;
        height: 1rem;
        color: rgba(11, 11, 16, 0.6);
      }

      .skin-portrait-text {
        font-size: 0.75rem;
        font-weight: 500;
        letter-spacing: -0.03em;
        line-height: 1rem;
        color: rgba(11, 11, 16, 0.72);
      }

      /* ---------- Copilot / Overlay (keep yours) ---------- */
      #copilotContainer {
        position: fixed;
        inset: 0;
        z-index: 10;
        background: #fff;
        display: flex;
      }
      #copilotSA {
        width: 100%;
        height: 100%;
      }
      #glamarOverlay {
        position: fixed;
        inset: 0;
        z-index: 999999;
        background: rgba(0, 0, 0, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
      }
      #glamarModal {
        position: relative;
        width: 100%;
        height: 100%;
        background: #fff;

        overflow: hidden;
      }
      #GlamAR-Container {
        width: 100%;
        height: 100%;
        background: #fff;
        overflow: hidden;
      }

      .loader {
        width: 100%;
        height: 100%;
        background: #00000052;
        position: fixed;
        z-index: 1000000;
        display: none;
        align-items: center;
        justify-content: center;
      }
      .loader.active {
        display: flex;
      }
      .loader svg {
        max-width: 200px;
        max-height: 200px;
      }

      /* ---------- Required media queries ---------- */

      @media (min-width: 648px) {
        /* Desktop/tablet layout (your current look) */
        main {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 1.75rem 1.5rem;
          gap: 3rem;
        }

        .hero-wrap {
          position: static;
          grid-row: auto;
          align-self: auto;
          justify-self: auto;
          pointer-events: auto;
        }

        .panel {
          width: 100%;
          max-width: 38rem;
          border-radius: var(--r-panel);
          border: 0.0625rem solid var(--c-panel-border);
          box-shadow: 0 1.5rem 3.2rem -2rem var(--c-panel-shadow);
          overflow: hidden;
          background: linear-gradient(
            180deg,
            transparent 0%,
            rgba(160, 140, 255, 0.08) 2%,
            var(--c-band) 100%
          );
        }

        /* composer back inside panel */
        .panel-inner {
          position: static;
          left: auto;
          right: auto;
          bottom: auto;
          z-index: auto;
          display: flex;
          flex-direction: column;
          gap: 1rem;
          width: auto;
          padding: 0;
          background: transparent;
        }

        .composer-inner {
          border-bottom: 0.0625rem solid rgba(190, 190, 210, 0.45);
          border-radius: var(--r-lg);
          background: rgba(255, 255, 255, 0.9);
          padding: 0.95rem;
          display: grid;
          grid-template-rows: auto auto;
          gap: 2.4rem;
          backdrop-filter: none;
          -webkit-backdrop-filter: none;
        }

        .composer-bottom {
          display: grid;
          grid-template-columns: 1fr auto;
          gap: 0.9rem;
          align-items: end;
        }

        .chips {
          display: flex;
          flex-direction: row;
          gap: 0.55rem;
          align-items: flex-start;
          min-width: 0;
        }

        .suggestion-btn {
          background: var(--c-chip);
          border: 0;
          color: var(--c-chip-text);
          padding: 0.45rem 0.95rem;
          border-radius: var(--r-pill);
          font-size: 0.875rem;
          line-height: 1.25rem;
          cursor: pointer;
          max-width: 100%;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .suggestion-btn:hover {
          background: linear-gradient(
            120deg,
            var(--c-glow-blue-dark) 50%,
            var(--c-glow-violet-dark) 100%
          );
        }

        .composer-input {
          font-size: 0.875rem;
          line-height: 1.25rem;
          letter-spacing: -0.02em;
          height: auto;
          max-height: 7.6rem;
          overflow-y: auto;
        }

        .panel-band {
          padding: 1rem;
        }

        .features-container {
          grid-template-columns: 1fr 1fr;
          gap: 0.5rem;
        }

        .feature-card {
          background: var(--c-card);

          border-radius: var(--r-lg);
          box-shadow: 0 1.2rem 2.4rem -2rem var(--c-card-shadow);
        }

        .feature-image {
          border-radius: var(--r-md);
          padding: 0.35rem;
        }

        .feature-description {
          font-size: 0.92rem;
        }

        /* Skin Portrait back below panel (not fixed) */
        .skin-portrait-pill {
          position: static;
          top: auto;
          left: auto;
          z-index: auto;

          gap: 0.7rem;
          padding: 0.1rem 1rem 0.1rem 0.1rem;
          border-radius: var(--r-pill);
          box-shadow: 0 1.4rem 2.8rem -2.2rem rgba(65, 55, 160, 0.12);
          background: linear-gradient(
            120deg,
            #c7666699 0%,
            rgb(255 255 255 / 30%) 0%,
            rgb(255 255 255) 100%
          );
          backdrop-filter: none;
          -webkit-backdrop-filter: none;
        }

        .skin-portrait-pill:hover {
          background: linear-gradient(
            120deg,
            var(--c-glow-blue) 50%,
            var(--c-glow-violet) 100%
          );
        }

        .skin-portrait-plus {
          width: 2.5rem;
          height: 2.5rem;
          background: white;
        }

        .cta {
          background: var(--c-send-bg);
          border-color: var(--c-send-border);
        }

        .cta svg {
          width: 1.15rem;
          height: 1.15rem;
        }
      }
    </style>
  </head>

  <body>
    <div id="loader" class="loader"></div>

    <main>
      <div class="hero-wrap">
        <h1 class="hero-title">SkinGPT</h1>
        <p class="hero-subtitle">Your AI skincare assistant</p>
      </div>

      <div class="panel">
        <div class="panel-inner">
          <div class="composer">
            <div class="composer-inner">
              <textarea
                class="composer-input"
                rows="1"
                placeholder="How can I help you today?"
              ></textarea>

              <div class="composer-bottom">
                <div class="chips">
                  <button class="suggestion-btn" type="button">
                    How do I improve my skin texture?
                  </button>
                  <button class="suggestion-btn" type="button">
                    Recommend a good moisturizer
                  </button>
                </div>

                <button class="cta" type="button" aria-label="Send">
                  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path
                      d="M12 5v14m0-14l-6 6m6-6l6 6"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="panel-band">
          <div class="features-container">
            <div class="feature-card" id="analyze" role="button" tabindex="0">
              <img
                class="feature-image"
                id="analyzeImg"
                src="https://storage.googleapis.com/skinchat-core-dev-releases-asia-east1/0.5.1/br/dist/immutable/assets/analysis.ZSryxJbS.png"
                alt=""
              />
              <div class="feature-card-texts">
                <span class="feature-title">
                  <b>Analyze my skin</b>
                  by taking a quick photo
                </span>
              </div>
            </div>

            <div
              class="feature-card"
              id="personalise"
              role="button"
              tabindex="0"
            >
              <img
                class="feature-image"
                id="personaliseImg"
                src="https://storage.googleapis.com/skinchat-core-dev-releases-asia-east1/0.5.1/br/dist/immutable/assets/routine.CBHeyKkM.png"
                alt=""
              />
              <div class="feature-card-texts">
                <span class="feature-title">
                  Build my personalized <b>skincare routine</b>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <a
        href="/skin-portrait"
        class="skin-portrait-pill"
        aria-label="Skin Portrait"
      >
        <span class="skin-portrait-plus" aria-hidden="true">
          <svg id="portrait-plus" viewBox="0 0 24 24" fill="none">
            <path
              d="M12 5v14M5 12h14"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
          <img
            class="portrait-image"
            id="portrait-image"
            src=""
            alt=""
            referrerpolicy="no-referrer"
          />
        </span>
        <span class="skin-portrait-text">Skin Portrait</span>
      </a>
    </main>

    <div id="copilotContainer"><div id="copilotSA"></div></div>

    <script src="https://cdn.glamarz0.de/sdk/wrapper"></script>
    <script src="https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js"></script>

    <script type="application/javascript">
      const SA_BASE = "https://api.pixelbinz0.de/service/platform/misc/v1.0";
      const LS_KEY = "GLAMAR_SA:data";
      (async () => {
        const localData = getLocalData();
        console.log("localData:", localData);

        if (localData?.hostId) {
          try {
            const res = await getScans(
              localData?.additionalFields?.appId,
              localData?.hostId,
              localData?.additionalFields?.accessToken,
            );
            console.log("getScans result:", res);

            const items = res?.items || [];
            const portraitPlus = document.getElementById("portrait-plus");
            const portraitImage = document.getElementById("portrait-image");
            for (let i = 0; i < Math.min(items.length, 10); i++) {
              const imageUrl = items[i]?.report_data?.input?.image;

              if (typeof imageUrl === "string" && imageUrl.trim()) {
                portraitImage.style.display = "block";
                portraitPlus.style.display = "none";

                portraitImage.src = imageUrl;
                break;
              }
            }
          } catch (e) {
            console.error("getScans failed:", e);
          }
        }
      })();

      const loader = document.getElementById("loader");
      let loaderAnimation = null;

      function initLoader() {
        if (!loader || loaderAnimation) return;

        loaderAnimation = lottie.loadAnimation({
          container: loader,
          renderer: "svg",
          loop: true,
          autoplay: true,
          width: "200px",
          height: "200px",
          path: "https://cdn.pixelbin.io/v2/dummy-cloudname/original/__glam_ar/__sdk/saloader_light.json",
        });
      }

      function showLoader() {
        initLoader();
        document.getElementById("loader")?.classList.add("active");
      }

      function hideLoader() {
        document.getElementById("loader")?.classList.remove("active");
      }

      async function showCopilot(
        userSettings = {
          hostId: "1234",
          email: "example@gmail.com",
          additionalFields: {},
        },
      ) {
        let copilotReady = false;
        showLoader();
        copilotContainer.style.display = "flex";

        (function (w, d, s, o, f, js, fjs) {
          w[o] =
            w[o] ||
            function () {
              (w[o].q = w[o].q || []).push(arguments);
            };
          js = d.createElement(s);
          fjs = d.getElementsByTagName(s)[0];
          js.id = o;
          js.src = f;
          js.async = 1;
          js.referrerPolicy = "origin";
          fjs.parentNode.insertBefore(js, fjs);
        })(
          window,
          document,
          "script",
          "copilot",
          "https://script.copilot.live/v1/copilot.min.js?tkn=cat-pnxlzhq8",
        );

        copilot(
          "init",
          { element: "copilotSA", position: "initial" },
          function () {
            try {
              window?.copilot?.users?.set?.(userSettings);
            } catch (e) {
              console.warn("users.set failed:", e);
            }
            copilotReady = true;
            hideLoader();

            try {
              window?.copilot.callbacks.add({
                name: "open_glamar",
                handler: (args) => {
                  console.log("open_glamar clicked", args);
                  showGlamARSdk();
                  return { success: true };
                },
              });
            } catch (e) {
              console.warn("open_glamar callback attachment failed", e);
            }
          },
        );

        while (!copilotReady) {
          await new Promise((resolve) => setTimeout(resolve, 50));
        }
        return copilotReady;
      }

      let glamAROverlay = null;
      let glamARContainer = null;

      const copilotContainer = document.getElementById("copilotContainer");
      const analyzeBtn = document.getElementById("analyze");
      const personaliseBtn = document.getElementById("personalise");
      const textarea = document.querySelector(".composer-input");
      const chips = document.querySelectorAll(".suggestion-btn");
      const sendBtn = document.querySelector(".cta");

      copilotContainer.style.display = "none";

      const autosize = () => {
        textarea.style.height = "auto";
        const maxH = parseFloat(getComputedStyle(textarea).maxHeight || "9999");
        textarea.style.height = Math.min(textarea.scrollHeight, maxH) + "px";
      };

      const setSendState = () => {
        const hasText = textarea.value.trim().length > 0;
        sendBtn.classList.toggle("is-active", hasText);
        sendBtn.classList.toggle("is-disabled", !hasText);
        sendBtn.disabled = !hasText;
      };

      autosize();
      setSendState();

      textarea.addEventListener("input", () => {
        autosize();
        setSendState();
      });

      chips.forEach((btn) => {
        btn.addEventListener("click", () => {
          textarea.value = btn.textContent.trim();
          textarea.focus();
          autosize();
          setSendState();
        });
      });

      personaliseBtn.addEventListener("click", async () => {
        await showCopilot();
        copilot("event", "sendUserMessage", {
          value: "Build my personalized skincare routine",
        });
      });

      sendBtn.addEventListener("click", async () => {
        const message = textarea.value.trim();
        if (!message) return;

        await showCopilot();
        copilot("event", "sendUserMessage", { value: message });

        textarea.value = "";
        textarea.style.height = "auto";
        setSendState();
      });

      analyzeBtn.addEventListener("click", () => {
        showGlamARSdk();
      });

      function ensureOverlay() {
        if (document.getElementById("glamarOverlay")) {
          glamAROverlay = document.getElementById("glamarOverlay");
          glamARContainer = document.getElementById("GlamAR-Container");
          return;
        }

        const overlay = document.createElement("div");
        overlay.id = "glamarOverlay";
        overlay.innerHTML = `
          <div id="glamarModal">
            <div id="GlamAR-Container"></div>
            <button id="closeSdkBtn" aria-label="Close">Ã—</button>
          </div>
        `;
        document.body.appendChild(overlay);

        glamAROverlay = overlay;
        glamARContainer = document.getElementById("GlamAR-Container");
      }

      function showGlamARSdk() {
        ensureOverlay();
        glamAROverlay.style.display = "flex";
        initGlamAr();
      }

      function closeGlamARSdk() {
        try {
          if (window.GlamAR && typeof window.GlamAR.close === "function")
            window.GlamAR.close();
        } catch (e) {}
        if (glamAROverlay) glamAROverlay.style.display = "none";
        if (glamARContainer)
          while (glamARContainer.firstChild)
            glamARContainer.removeChild(glamARContainer.firstChild);
        window.__GLAMAR_INITIALIZED__ = false;
      }

      function initGlamAr() {
        ensureOverlay();
        glamAROverlay.style.display = "flex";

        if (window.__GLAMAR_INITIALIZED__) return;
        if (!window.GlamAR || typeof window.GlamAR.init !== "function") {
          console.error("GlamAR wrapper missing");
          return;
        }
        showLoader();

        window.__GLAMAR_INITIALIZED__ = true;

        const config = {
          platform: "web",
          category: "skingpt",
          meta: { sdkVersion: "2.0.0" },
          configuration: {
            skinAnalysis: { appId: "fecf3bc7-c9ec-4c47-8555-98a74df58288" },
          },
        };

        window.GlamAR.init(
          "GlamAR-Container",
          "ba843e66-4b93-48f6-a02e-ea48d920e52e",
          config,
        );

        window.GlamAR.addEventListener?.("*", async (event, payload) => {
          if (event === "loading") hideLoader();
          if (event === "closed") closeGlamARSdk();

          if (event === "skin-gpt") {
            try {
              const {
                accessToken,
                scanId,
                predictionId,
                appId,
                subjectId,
                retouchPredictionId,
                currencySymbols,
              } = payload || {};
              console.log("result", payload);

              const userSettings = {
                hostId: subjectId,
                email: "example@gmail.com",
                additionalFields: {
                  predictionId,
                  scanId,
                  retouchPredictionId,
                  accessToken,
                  appId,
                  currencySymbols,
                },
              };

              await showCopilot(userSettings);
              closeGlamARSdk();
              copilot("event", "sendUserMessage", {
                value: "analyze my skin",
              });
              setLocalData(userSettings);
            } catch (e) {
              console.error("Error handling skin-gpt:", e);
            }
          }
        });
      }

      async function getScans(appId, subjectId, SA_BEARER) {
        const url = `${SA_BASE}/apps/${appId}/subjects/${subjectId}/scans?pageNo=1&pageSize=10`;
        const res = await fetch(url, {
          method: "GET",
          headers: {
            accept: "application/json, text/plain, */*",
            authorization: `Bearer ${btoa(unescape(encodeURIComponent(SA_BEARER)))}`,
          },
        });
        if (!res.ok) {
          const t = await res.text().catch(() => "");
          throw new Error(`GET skinAnalysis failed ${res.status}: ${t}`);
        }
        return res.json();
      }

      function setLocalData(data) {
        try {
          localStorage.setItem(LS_KEY, JSON.stringify(data));
          return true;
        } catch (e) {
          console.warn("setLocalData failed:", e);
          return false;
        }
      }

      function getLocalData() {
        try {
          const raw = localStorage.getItem(LS_KEY);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (e) {
          console.warn("getLocalData parse failed:", e);
          return null;
        }
      }
    </script>
  </body>
</html>
